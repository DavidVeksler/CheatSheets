<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Human Evolution: Journey Through Time (Concise)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      :root {
        --sidebar-width: 380px;
        --header-height: 60px;
        --primary-accent: #0d6efd;
        --danger-accent: #dc3545;
        --dark-bg: #161618;
        --medium-bg: #212124;
        --light-bg: #303033;
        --text-color: #f0f0f0;
        --text-muted-color: #d0d0d0;
        --timeline-period-color: #6cb2f7;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        overflow: hidden;
        background: var(--dark-bg);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header.app-header {
        height: var(--header-height);
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
      }

      header.app-header h1 {
        font-size: 1.4rem;
        font-weight: 300;
        margin: 0;
        letter-spacing: 0.5px;
      }

      #main-content {
        display: flex;
        height: calc(100vh - var(--header-height));
        flex-grow: 1;
      }

      #controls-sidebar {
        width: var(--sidebar-width);
        background: var(--medium-bg);
        border-right: 1px solid var(--light-bg);
        overflow-y: auto;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      @media (max-width: 992px) {
        #main-content {
          flex-direction: column;
        }

        #controls-sidebar {
          width: 100%;
          max-height: 45vh;
          border-right: none;
          border-bottom: 1px solid var(--light-bg);
        }

        #map-container {
          flex-grow: 1;
          height: auto;
        }
      }

      #map-container {
        flex: 1;
        position: relative;
        background: #0a0a0a;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .control-card {
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
        border-radius: 5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
      }

      .control-card .card-header {
        font-size: 0.85rem;
        font-weight: 500;
        background-color: var(--light-bg);
        color: var(--text-muted-color);
        border-bottom: 1px solid var(--light-bg);
        padding: 0.4rem 0.6rem;
        display: flex;
        align-items: center;
      }

      .control-card .card-header i {
        margin-right: 0.4rem;
        font-size: 0.9em;
      }

      .control-card .card-body {
        padding: 0.6rem;
      }

      #current-period-display {
        font-size: 1.15rem;
        font-weight: bold;
        margin-top: 0.1rem;
        margin-bottom: 0.05rem;
        text-align: center;
        color: var(--timeline-period-color);
      }

      #timeline-value-display { /* MODIFIED ID HERE */
        font-weight: normal;
        font-size: 0.7rem;
        color: var(--text-muted-color);
        display: block;
        text-align: center;
        margin-bottom: 0.5rem;
      }

      #timeline-scrubber {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #505050;
        outline: none;
        margin: 0.5rem 0;
      }

      #timeline-scrubber::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-accent);
        cursor: pointer;
        box-shadow: 0 0 4px rgba(var(--primary-accent), 0.6);
      }

      #timeline-scrubber::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-accent);
        cursor: pointer;
        border: none;
        box-shadow: 0 0 4px rgba(var(--primary-accent), 0.6);
      }

      .timeline-buttons .btn,
      .timeline-buttons .btn-group {
        margin-top: 0.25rem;
      }

      .timeline-buttons .btn {
        padding: 0.25rem 0.6rem;
        font-size: 0.8rem;
      }

      .timeline-buttons .btn i {
        margin-right: 0.25rem;
      }

      #reset-button {
        background-color: var(--danger-accent);
        border-color: var(--danger-accent);
        color: white;
      }

      #reset-button:hover {
        filter: brightness(90%);
      }

      .quick-filter-buttons .btn {
        margin-right: 0.25rem;
        font-size: 0.75rem;
        padding: 0.2rem 0.45rem;
      }

      .btn-outline-light {
        color: var(--text-muted-color);
        border-color: var(--light-bg);
      }

      .btn-outline-light:hover,
      .btn-outline-light.active {
        color: var(--dark-bg);
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
        font-weight: 500;
      }

      #species-filter-list {
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        border-radius: 4px;
        padding: 0.25rem;
        margin-top: 0.5rem;
      }

      #species-filter-list .form-check {
        padding: 0.2rem 0.4rem;
        border-bottom: 1px solid var(--light-bg);
        display: flex;
        align-items: center;
      }

      #species-filter-list .form-check:last-child {
        border-bottom: none;
      }

      #species-filter-list .form-check-label {
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 0.4rem;
        color: var(--text-color);
      }

      #species-filter-list .form-check-input {
        cursor: pointer;
        margin-top: 0;
        width: 0.9em;
        height: 0.9em;
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
      }

      #species-filter-list .form-check-input:checked {
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
      }

      .species-color-indicator {
        width: 10px;
        height: 10px;
        display: inline-block;
        margin-left: 0.3rem;
        border-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #narrative-panel .card-body {
        font-size: 0.8rem;
        line-height: 1.5;
        color: var(--text-color);
        overflow-y: auto;
      }

      #narrative-panel .card-body strong {
        color: var(--timeline-period-color);
      }

      .data-limitation-note {
        color: #ffc107;
        font-size: 0.75rem;
        margin-top: 0.5rem;
        border-top: 1px dashed var(--light-bg);
        padding-top: 0.5rem;
      }

      .data-limitation-note i {
        margin-right: 0.25rem;
      }

      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 0.5rem 0.75rem;
        background: rgba(30, 30, 32, 0.92);
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        z-index: 1000;
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        color: var(--text-color);
      }

      .legend h5 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 0.85rem;
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 3px;
      }

      .legend h5 i {
        font-size: 0.85em;
        margin-right: 0.25rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
        font-size: 0.7rem;
      }

      .legend-color-box {
        width: 10px;
        height: 10px;
        margin-right: 5px;
        border: 1px solid #777;
        opacity: 0.8;
        flex-shrink: 0;
        border-radius: 2px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        z-index: 9999;
        flex-direction: column;
      }

      .loading-overlay .spinner-border {
        width: 2.5rem;
        height: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .climate-toggle-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--medium-bg);
        padding: 0.4rem 0.6rem;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--light-bg);
      }

      .climate-toggle-container .form-check-label {
        font-size: 0.75rem;
        color: var(--text-muted-color);
      }

      .climate-toggle-container .form-check-input {
        border-color: var(--primary-accent);
      }

      .climate-toggle-container .form-check-input:checked {
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
      }

      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        background-color: var(--medium-bg) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--light-bg) !important;
        border-radius: 4px !important;
      }

      .leaflet-control-zoom-in:hover,
      .leaflet-control-zoom-out:hover {
        background-color: var(--light-bg) !important;
      }

      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: var(--medium-bg);
        color: var(--text-color);
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--light-bg);
      }

      .leaflet-popup-content h5 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.05em;
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 5px;
      }

      .leaflet-container a.leaflet-popup-close-button {
        color: var(--text-muted-color);
      }
    </style>
  </head>

  <body>
    <div id="loading-screen" class="loading-overlay">
      <div class="spinner-border text-light" role="status"></div>
      <p class="mt-2 mb-0">Loading Evolution Data...</p>
    </div>
    <header class="app-header">
      <h1><i class="bi bi-globe-americas"></i> Human Evolution: A Journey Through Time</h1>
    </header>
    <div id="main-content">
      <aside id="controls-sidebar">
        <div id="controls-content" class="d-none h-100 d-flex flex-column">
          <div class="control-card card">
            <div class="card-header"><i class="bi bi-clock-history"></i> Timeline Control</div>
            <div class="card-body">
              <div id="current-period-display">Data not loaded.</div>
              <span id="timeline-value-display"></span> <!-- MODIFIED ID HERE -->
              <input
                type="range"
                class="form-range"
                id="timeline-scrubber"
                min="0"
                value="0"
                disabled
                data-bs-toggle="tooltip"
                title="Drag to select a time period"
              />
              <div class="d-flex justify-content-between align-items-center mt-2 timeline-buttons">
                <button
                  id="play-pause-button"
                  class="btn btn-primary btn-sm"
                  disabled
                  data-bs-toggle="tooltip"
                  title="Play or Pause animation"
                >
                  <i class="bi bi-play-fill"></i> <span>Play</span>
                </button>
                <div
                  class="btn-group btn-group-sm"
                  role="group"
                  data-bs-toggle="tooltip"
                  title="Adjust animation speed"
                >
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="1">1x</button>
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="2">2x</button>
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="5">5x</button>
                </div>
                <button
                  id="reset-button"
                  class="btn btn-danger btn-sm"
                  disabled
                  data-bs-toggle="tooltip"
                  title="Reset timeline to start"
                >
                  <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
              </div>
            </div>
          </div>
          <div class="control-card card">
            <div class="card-header"><i class="bi bi-people-fill"></i> Species Filter</div>
            <div class="card-body">
              <div class="btn-group btn-group-sm mb-2 quick-filter-buttons" role="group">
                <button class="btn btn-outline-light" id="filter-all" data-bs-toggle="tooltip" title="Show all species">
                  All
                </button>
                <button
                  class="btn btn-outline-light"
                  id="filter-none"
                  data-bs-toggle="tooltip"
                  title="Hide all species"
                >
                  None
                </button>
                <button
                  class="btn btn-outline-light"
                  id="filter-homo"
                  data-bs-toggle="tooltip"
                  title="Show only Homo genus"
                >
                  Homo
                </button>
              </div>
              <div id="species-filter-list">
                <p class="text-muted p-2 small">No species data loaded.</p>
              </div>
            </div>
          </div>
          <div id="narrative-panel" class="control-card card flex-grow-1 mb-0">
            <div class="card-header"><i class="bi bi-book-half"></i> Period Overview</div>
            <div class="card-body">
              <p id="narrative-text-element" class="text-muted">Select a time period to see an overview.</p> <!-- MODIFIED ID HERE -->
              <p class="data-limitation-note">
                <i class="bi bi-exclamation-triangle-fill"></i> Note: Geographic map display depends on data in the
                fetched dataset. Active species are listed in the legend.
              </p>
            </div>
          </div>
        </div>
      </aside>
      <main id="map-container">
        <div id="map"></div>
        <div class="climate-toggle-container">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="climate-toggle-switch"
              data-bs-toggle="tooltip"
              title="Toggle Last Glacial Maximum ice sheets"
            />
            <label class="form-check-label" for="climate-toggle-switch">Ice Sheets</label>
          </div>
        </div>
        <div id="legend" class="legend">
          <h5><i class="bi bi-palette"></i> Legend</h5>
          <div id="legend-items-container"><small class="text-muted">Data not loaded.</small></div>
        </div>
      </main>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   
    <script>
        // --- State & Config ---
        let timePeriodsData = [];
        const map = L.map('map', { worldCopyJump: true, zoomControl: false }).setView([20, 40], 2);
        L.control.zoom({ position: 'topleft' }).addTo(map); // Added zoom control to topleft
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd', maxZoom: 19
        }).addTo(map);
    
        let iceSheetLayerGroup = L.layerGroup();
        let speciesGeoJsonLayerGroup = L.layerGroup().addTo(map); // Layer for species ranges/migrations
    
        let currentPeriodIndex = 0;
        let selectedSpecies = {};
        let allSpeciesList = [];
        let isPlaying = false;
        let animationFrameId;
        let lastFrameTime = 0;
        let playbackSpeed = 1; // 1x, 2x, 5x
        const baseAnimationInterval = 3500; // Milliseconds for 1x speed to change period
    
        // --- DOM Elements Cache ---
        const domElements = {
            timelineScrubber: null,
            currentPeriodDisplay: null,
            timelineValueDisplay: null,
            speciesFilterList: null,
            legendItemsContainer: null,
            playPauseButton: null,
            playPauseIcon: null, // Will be derived from playPauseButton
            playPauseText: null, // Will be derived from playPauseButton
            resetButton: null,
            narrativeTextElement: null,
            loadingScreen: null,
            controlsContentDiv: null,
            climateToggle: null
        };
    
        function populateDomElements() {
        // Map JS keys to actual HTML IDs if they differ significantly from kebab-case conversion
        const idMap = {
            controlsContentDiv: 'controls-content', // Explicit mapping
            climateToggle: 'climate-toggle-switch' // Explicit mapping for the switch input
            // Add other explicit mappings here if needed
        };

        for (const key in domElements) {
            if (key === 'playPauseIcon' || key === 'playPauseText') continue;

            // Use mapped ID if available, otherwise convert camelCase to kebab-case
            const elementId = idMap[key] || key.replace(/([A-Z])/g, '-$1').toLowerCase();
            domElements[key] = document.getElementById(elementId);

            if (!domElements[key]) {
                console.warn(`DOM element with ID '${elementId}' (for key '${key}') not found.`);
            }
        }

        if (domElements.playPauseButton) {
            domElements.playPauseIcon = domElements.playPauseButton.querySelector('i');
            domElements.playPauseText = domElements.playPauseButton.querySelector('span');
            if (!domElements.playPauseIcon) console.warn("Play/Pause button icon (<i>) not found.");
            if (!domElements.playPauseText) console.warn("Play/Pause button text (<span>) not found.");
        } else {
            console.error("playPauseButton element not found, cannot derive icon and text elements.");
        }
    }

    
    
        const iceSheetGeoJson = {
    lgm_laurentide: {
        "type": "Polygon",
        "coordinates": [[
            [-125, 48], [-120, 45], [-115, 42], [-110, 40], [-100, 38], [-95, 37.5], [-90, 38], [-85, 39], [-80, 40], [-75, 40.5], [-70, 41], [-65, 42], [-60, 43], // Southern Edge (West to East)
            [-55, 48], [-50, 55], [-50, 60], [-55, 65], [-60, 70], [-70, 75], [-80, 78], [-90, 80], [-100, 80], [-110, 78], [-120, 75], [-130, 70], [-135, 65], [-130, 60], [-125, 55], // Northern/Western Edge
            [-125, 48]
        ]]
    },
    lgm_cordilleran: {
        "type": "Polygon",
        "coordinates": [[
            [-140, 62], [-135, 58], [-130, 55], [-125, 50], [-120, 47], // Eastern Edge (South to North, approximate)
            [-122, 45], [-125, 46], [-130, 48], [-135, 52], [-140, 55], [-145, 58], [-142, 60], // Western Edge (South to North, approximate Pacific coast)
            [-140, 62]
        ]]
    },
    lgm_fennoscandian: {
        "type": "Polygon",
        "coordinates": [[
            [-10, 50], [0, 48], [10, 48], [20, 50], [30, 52], [40, 53], [50, 55], [60, 58], // Southern Edge (West to East, into Russia)
            [70, 60], [75, 65], [70, 70], [60, 72], [50, 75], [40, 78], [30, 75], [20, 72], [10, 70], [0, 65], [-5, 60], [-10, 55], // Northern Edge (East to West)
            [-10, 50]
        ]]
    },
    lgm_barents_kara: { // Often considered with Fennoscandian but had distinct centers
        "type": "Polygon",
        "coordinates": [[
            [30, 68], [40, 65], [50, 62], [60, 60], [70, 60], [80, 62], [90, 65], // Southern edge over land
            [95, 70], [90, 75], [80, 80], [70, 82], [60, 82], [50, 80], [40, 78], [30, 75], // Northern extent in Arctic Ocean
            [30, 68]
        ]]
    },
    lgm_greenland: {
        "type": "Polygon",
        "coordinates": [[
            [-75, 80], [-60, 83], [-40, 85], [-20, 83], [-15, 75], [-20, 70], [-25, 65], [-30, 60], [-40, 58], [-50, 57], [-60, 58], [-70, 60], [-78, 65], [-80, 70], [-78, 75],
            [-75, 80]
        ]]
    },
    lgm_iceland: {
        "type": "Polygon",
        "coordinates": [[
            [-25, 63], [-20, 62.5], [-15, 63], [-13, 64], [-14, 66], [-18, 67], [-22, 67], [-26, 66], [-25, 64],
            [-25, 63]
        ]]
    },
    lgm_alpine: { // European Alpine Ice Cap
        "type": "Polygon",
        "coordinates": [[
            [5, 45.5], [7, 45], [9, 44.5], [11, 44.5], [13, 45], [15, 45.5], // Southern extent
            [16, 46.5], [15, 47.5], [13, 48], [11, 48.5], [9, 48.5], [7, 48], [5.5, 47.5], // Northern extent
            [5, 45.5]
        ]]
    },
    lgm_patagonian: {
        "type": "Polygon",
        "coordinates": [[
            [-75, -38], [-72, -37], [-69, -38], [-68, -40], [-67, -45], [-66, -50], [-65, -54], // Eastern extent
            [-68, -56], [-72, -55], [-75, -52], [-76, -48], [-77, -45], [-76, -42], // Western extent (Pacific side)
            [-75, -38]
        ]]
    },
    lgm_antarctic_west: { // West Antarctic Ice Sheet - grounded further out
         "type": "Polygon",
         "coordinates": [[
            [-60, -70], [-50, -72], [-40, -75], [-50, -78], [-70, -80], [-90, -82], [-110, -80], [-130, -78], [-150, -75], [-170, -72], // Ross Sea / Ronne-Filchner grounding line approximations
            [-170, -70], [-150, -68], [-130, -66], [-110, -65], [-90, -64], [-70, -65], [-60, -68], // Seaward edge
            [-60, -70]
         ]]
    },
    lgm_antarctic_east: { // East Antarctic Ice Sheet - generally similar but with some coastal expansion
         "type": "Polygon",
         "coordinates": [[
            [20, -65], [40, -64], [60, -64], [80, -65], [100, -66], [120, -66], [140, -65], [160, -64], [170, -65], // Coastal edge
            [170, -75], [160, -80], [140, -85], [120, -88], [100, -88], [80, -85], [60, -80], [40, -75], [20, -70], // Inland (approximating current bulk with some expansion)
            [20, -65]
         ]]
    }
    // Note: More localized ice caps in areas like the Tibetan Plateau, New Zealand Alps, British-Irish Ice Sheet (sometimes shown separate from Fennoscandian) could be added for even greater detail.
    // The British-Irish Ice Sheet is complex; part could be merged with Fennoscandian thinking or drawn separately:
    ,
    lgm_british_irish: {
        "type": "Polygon",
        "coordinates": [[
            [-12, 50], [-8, 49], [-5, 49.5], [0, 50], [2, 52], [0, 55], [-2, 58], [-5, 60], [-8, 61], [-10, 60], [-13, 58], [-14, 55], [-12, 52],
            [-12, 50]
        ]]
    }
};
    
        // --- Core Functions ---
        async function fetchEvolutionData() {
        try {
            const response = await fetch('https://cheatsheets.davidveksler.com/evolution_data.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            timePeriodsData = await response.json();
            if (!Array.isArray(timePeriodsData) || timePeriodsData.length === 0) {
                 throw new Error("Fetched data is not a valid array or is empty.");
            }
            initializeApplication();
        } catch (error) {
            console.error("Could not fetch evolution data:", error);
            // Ensure domElements are populated before trying to access them here
            if (domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.innerHTML = "<strong class='text-danger'>Error loading data.</strong>";
            if (domElements.loadingScreen) domElements.loadingScreen.innerHTML = `<div class='p-3 text-center'><i class='bi bi-exclamation-triangle-fill text-danger h1'></i><p>Failed to load evolution data from source.<br><small>${error.message}</small></p></div>`;
        }
    }
    
    function initializeApplication() {
        if (!domElements.loadingScreen || !domElements.controlsContentDiv) {
            console.error("Core UI elements (loadingScreen or controlsContentDiv) not found. Cannot initialize application properly.");
            // Display a more prominent error to the user if these are missing
            document.body.innerHTML = `<div class='p-5 text-center text-danger'><h1>Application Error</h1><p>Essential UI components are missing. Please check the HTML structure and element IDs.</p></div>`;
            return;
        }

        domElements.loadingScreen.style.display = 'none';
        domElements.controlsContentDiv.classList.remove('d-none');

        Object.values(domElements).forEach(el => {
            if (el && typeof el.disabled === 'boolean') {
                el.disabled = false;
            }
        });
        if (domElements.timelineScrubber) {
             domElements.timelineScrubber.max = timePeriodsData.length - 1;
        }

        populateAllSpeciesList();
        populateSpeciesFilter();
        currentPeriodIndex = 0;
        updateUIForCurrentPeriod();
        updateSpeedButtonsActiveState();

        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
        function populateAllSpeciesList() {
            const speciesSet = new Map();
            timePeriodsData.forEach(period => {
                if (period.species && Array.isArray(period.species)) {
                    period.species.forEach(s => {
                        if (s && s.name && !speciesSet.has(s.name)) { // Basic validation
                            speciesSet.set(s.name, { color: s.color || '#cccccc' }); // Default color if missing
                        }
                    });
                }
            });
            allSpeciesList = Array.from(speciesSet, ([name, data]) => ({ name, ...data }));
            allSpeciesList.sort((a, b) => a.name.localeCompare(b.name));
        }
    
        function populateSpeciesFilter() {
            domElements.speciesFilterList.innerHTML = '';
            if (allSpeciesList.length === 0) {
                domElements.speciesFilterList.innerHTML = '<p class="text-muted p-2 small">No species found in data.</p>'; return;
            }
            allSpeciesList.forEach(s => {
                selectedSpecies[s.name] = true; // Select all by default
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-check';
                const input = document.createElement('input');
                input.type = 'checkbox'; input.className = 'form-check-input';
                input.id = `filter-${s.name.replace(/\W/g, '_')}`; input.value = s.name; input.checked = true;
                input.addEventListener('change', (event) => {
                    selectedSpecies[event.target.value] = event.target.checked;
                    updateUIForCurrentPeriod(); // Re-render legend and map features
                });
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'species-color-indicator';
                colorIndicator.style.backgroundColor = s.color;
    
                const label = document.createElement('label');
                label.className = 'form-check-label'; label.htmlFor = input.id;
                label.style.color = 'var(--text-color)'; // Use light text color for the label itself
                label.textContent = s.name;
    
                itemDiv.appendChild(input);
                itemDiv.appendChild(colorIndicator);
                itemDiv.appendChild(label);
                domElements.speciesFilterList.appendChild(itemDiv);
            });
        }
    
        function updateUIForCurrentPeriod() {
            speciesGeoJsonLayerGroup.clearLayers(); 
    
            if (!timePeriodsData || timePeriodsData.length === 0 || currentPeriodIndex < 0 || currentPeriodIndex >= timePeriodsData.length) {
                if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = `Timeline End`;
                if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = "(Drag scrubber or Reset)";
                if(domElements.narrativeTextElement) {
                    domElements.narrativeTextElement.style.color = 'var(--text-color)';
                    domElements.narrativeTextElement.textContent = "End of timeline data.";
                }
                if(domElements.legendItemsContainer) domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No active period.</small>';
                return;
            }
    
            const period = timePeriodsData[currentPeriodIndex];
            if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = period.periodName || "Unknown Period";
            if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = period.timeRange || `Period ${currentPeriodIndex + 1}`;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = currentPeriodIndex;
            
            if(domElements.narrativeTextElement) { // MODIFIED NARRATIVE UPDATE
                domElements.narrativeTextElement.style.color = 'var(--text-color)';
                domElements.narrativeTextElement.innerHTML = period.narrative || "No narrative available for this period."; // Use innerHTML if narrative can contain HTML
            }
    
            let speciesInCurrentPeriod = period.species || [];
            let visibleSpeciesInLegend = [];
    
            speciesInCurrentPeriod.forEach(s => {
                if (s && s.name && selectedSpecies[s.name]) {
                    visibleSpeciesInLegend.push(s); 
    
                    let popupContent = `<h5>${s.name}</h5>
                                        <p class="mb-1 small"><strong>Timeline:</strong> ${s.timeline || 'N/A'}</p>
                                        <p class="mb-0 small">${s.notes || 'No specific notes.'}</p>`;
    
                    if (s.estimatedRangeGeoJson && Object.keys(s.estimatedRangeGeoJson).length > 0) {
                        try {
                            L.geoJSON(s.estimatedRangeGeoJson, {
                                style: { fillColor: s.color || '#888888', weight: 1, opacity: 1, color: '#ccc', fillOpacity: 0.4 }
                            }).bindPopup(popupContent).addTo(speciesGeoJsonLayerGroup);
                        } catch (e) { console.warn("Error drawing range for", s.name, e); }
                    }
    
                    if (s.migrationPaths && Array.isArray(s.migrationPaths)) {
                        s.migrationPaths.forEach(path => {
                            if (path && Object.keys(path).length > 0) {
                               try {
                                    L.geoJSON(path, {
                                        style: { color: s.migrationColor || s.color || '#888888', weight: 2.5, opacity: 0.65, dashArray: '5, 5' }
                                    }).bindPopup(popupContent).addTo(speciesGeoJsonLayerGroup);
                                } catch (e) { console.warn("Error drawing migration for", s.name, e); }
                            }
                        });
                    }
                }
            });
            updateLegend(visibleSpeciesInLegend);
            updateClimateOverlay(period.timeRange);
        }
    
        function updateLegend(visibleSpecies) {
            domElements.legendItemsContainer.innerHTML = '';
            if (visibleSpecies.length === 0) {
                domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No species selected or in period.</small>'; return;
            }
            visibleSpecies.sort((a,b) => a.name.localeCompare(b.name));
            visibleSpecies.forEach(s => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'legend-item';
                const colorBox = document.createElement('span');
                colorBox.className = 'legend-color-box'; colorBox.style.backgroundColor = s.color || '#cccccc';
                const nameSpan = document.createElement('span'); nameSpan.textContent = s.name;
                nameSpan.style.color = 'var(--text-color)';
                itemDiv.appendChild(colorBox); itemDiv.appendChild(nameSpan);
                domElements.legendItemsContainer.appendChild(itemDiv);
            });
        }
    
        function parseYearFromRange(rangeString) {
            if (!rangeString) return { start: null, end: null };
            const cleaned = rangeString.toLowerCase().replace(/c\.|ago|years|million|kya|mya/g, '').trim();
            const parts = cleaned.split(/\s*-\s*|\s+to\s+/);
    
            function parsePart(part) {
                part = part.trim();
                let num = parseFloat(part.replace(/,/g, '')); 
                if (rangeString.toLowerCase().includes("million") || rangeString.toLowerCase().includes("mya")) {
                    num *= 1000000;
                } else if (rangeString.toLowerCase().includes("kya")) {
                    num *= 1000;
                }
                return isNaN(num) ? null : -Math.abs(num); 
            }
    
            let startYear = parsePart(parts[0]);
            let endYear = parts.length > 1 ? parsePart(parts[1]) : startYear;
    
            if (startYear && endYear === null) endYear = startYear;
            if (endYear && startYear === null) startYear = endYear;
    
            if (startYear && endYear && startYear > endYear) {
                [startYear, endYear] = [endYear, startYear];
            }
            return { start: startYear, end: endYear };
        }
    
        function updateClimateOverlay(periodTimeRange) {
            iceSheetLayerGroup.clearLayers();
            if (domElements.climateToggle.checked && periodTimeRange) {
                const { start, end } = parseYearFromRange(periodTimeRange);
                const lgmStart = -26500; 
                const lgmEnd = -19000;  
    
                if (start && end && Math.max(start, lgmStart) <= Math.min(end, lgmEnd)) {
                    Object.values(iceSheetGeoJson).forEach(sheet => {
                        L.geoJSON(sheet, {
                            style: { color: '#ADC8E6', fillColor: '#ADD8E6', fillOpacity: 0.3, weight: 1 }
                        }).addTo(iceSheetLayerGroup);
                    });
                }
            }
            if (!map.hasLayer(iceSheetLayerGroup) && domElements.climateToggle.checked && iceSheetLayerGroup.getLayers().length > 0) {
                map.addLayer(iceSheetLayerGroup);
            } else if (map.hasLayer(iceSheetLayerGroup) && (!domElements.climateToggle.checked || iceSheetLayerGroup.getLayers().length === 0)) {
                map.removeLayer(iceSheetLayerGroup);
            }
        }
    
        // --- Animation & Controls ---
        function animationLoop(timestamp) {
            if (!isPlaying) return;
    
            if (timestamp - lastFrameTime >= (baseAnimationInterval / playbackSpeed)) {
                lastFrameTime = timestamp;
                currentPeriodIndex++;
                if (currentPeriodIndex >= timePeriodsData.length) {
                    currentPeriodIndex = timePeriodsData.length - 1; 
                    pauseAnimation();
                }
                updateUIForCurrentPeriod();
            }
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function playAnimation() {
            if (!timePeriodsData || timePeriodsData.length === 0) return;
            isPlaying = true;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-pause-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Pause";
            lastFrameTime = performance.now();
            if (currentPeriodIndex >= timePeriodsData.length - 1 && timePeriodsData.length > 0) {
                currentPeriodIndex = 0;
            }
            updateUIForCurrentPeriod(); 
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function pauseAnimation() {
            isPlaying = false;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-play-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Play";
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
    
        function togglePlayPause() {
            if (isPlaying) {
                pauseAnimation();
            } else {
                playAnimation();
            }
        }
    
        function resetAnimation() {
            pauseAnimation();
            currentPeriodIndex = 0;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = 0;
            playbackSpeed = 1;
            updateSpeedButtonsActiveState();
            if (allSpeciesList && allSpeciesList.length > 0) {
                 Object.keys(selectedSpecies).forEach(sName => {
                    selectedSpecies[sName] = true;
                });
                 document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            }
            updateUIForCurrentPeriod();
        }
    
        function updateSpeedButtonsActiveState() {
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-light');
                if (parseInt(btn.dataset.speed) === playbackSpeed) {
                    btn.classList.add('active', 'btn-primary');
                    btn.classList.remove('btn-outline-light');
                }
            });
        }
    
        // --- Event Listeners ---
        function addEventListeners() {
            if (!domElements.timelineScrubber || !domElements.playPauseButton || !domElements.resetButton) { 
                console.error("Cannot add event listeners: Core DOM elements for controls not found.");
                return;
            }
            domElements.timelineScrubber.addEventListener('input', (event) => {
                currentPeriodIndex = parseInt(event.target.value);
                pauseAnimation();
                updateUIForCurrentPeriod();
            });
            domElements.playPauseButton.addEventListener('click', togglePlayPause);
            domElements.resetButton.addEventListener('click', resetAnimation);
    
            document.querySelectorAll('.speed-btn').forEach(button => {
                button.addEventListener('click', () => {
                    playbackSpeed = parseInt(button.dataset.speed);
                    updateSpeedButtonsActiveState();
                });
            });
            const filterAllBtn = document.getElementById('filter-all');
            if(filterAllBtn) filterAllBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => selectedSpecies[s.name] = true);
                document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateUIForCurrentPeriod();
            });
            const filterNoneBtn = document.getElementById('filter-none');
            if(filterNoneBtn) filterNoneBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => selectedSpecies[s.name] = false);
                document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateUIForCurrentPeriod();
            });
            const filterHomoBtn = document.getElementById('filter-homo');
            if(filterHomoBtn) filterHomoBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => {
                    const isHomo = s.name.toLowerCase().includes('homo');
                    selectedSpecies[s.name] = isHomo;
                    const cb = document.getElementById(`filter-${s.name.replace(/\W/g, '_')}`);
                    if(cb) cb.checked = isHomo;
                });
                updateUIForCurrentPeriod();
            });

            if(domElements.climateToggle) { 
                domElements.climateToggle.addEventListener('change', () => {
                    if (timePeriodsData.length > 0) { 
                         updateUIForCurrentPeriod(); 
                    }
                });
            }
        }
    
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDomElements(); 
            addEventListeners();   
            fetchEvolutionData();  
        });
        </script>

  </body>
</html>