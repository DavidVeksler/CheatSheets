<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Human Evolution: Journey Through Time (Concise) - AWESOME Edition v4 (Fossil Markers)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet"/>
<style>
      :root {
        /* Evolved Color Palette */
        --primary-accent-start: #00AFFF;
        --primary-accent-end: #0078D4;
        --primary-accent-gradient: linear-gradient(135deg, var(--primary-accent-start), var(--primary-accent-end));
        --primary-accent-static: #0095E0;

        --danger-accent: #FF4757;
        --danger-accent-rgb: 255,71,87; /* For rgba glow */
        --warning-accent: #FFA500;
        --warning-accent-rgb: 255,165,0; /* For rgba background tint */

        --dark-bg: #0F1014;
        --dark-bg-rgb: 15,16,20;
        --medium-bg: #1A1C23;
        --medium-bg-rgb: 26,28,35;
        --light-bg: #2C2F3B;
        --lighter-bg: #3D414F;

        --text-color: #E0E0E5;
        --text-muted-color: #90909A;
        --text-heading-color: #FFFFFF;

        --timeline-period-color: #FFC107; /* Amber for current period, also used for fossil markers */

        /* Typography */
        --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-weight-light: 300;
        --font-weight-regular: 400;
        --font-weight-medium: 500;
        --font-weight-bold: 600;

        /* UI Dimensions & Effects */
        --sidebar-width: 380px;
        --header-height: 65px;
        --border-radius-standard: 10px;
        --border-radius-pill: 50px;
        --transition-speed: 0.25s;
        --transition-timing: ease-out;
        --modern-shadow: 0 8px 24px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.15);
        --card-element-shadow: 0 2px 8px rgba(0,0,0,0.2);
        --focus-ring-color: rgba(0, 160, 255, 0.7); /* Primary accent with alpha */
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-primary);
        margin: 0;
        overflow: hidden;
        background: var(--dark-bg);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100vh;
        letter-spacing: 0.01em;
      }

      header.app-header {
        height: var(--header-height);
        background: var(--dark-bg);
        border-bottom: 2px solid var(--primary-accent-static);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        flex-shrink: 0;
      }

      header.app-header h1 {
        font-size: 1.5rem;
        font-weight: var(--font-weight-light);
        margin: 0;
        letter-spacing: 0.5px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        color: var(--text-heading-color);
      }
      header.app-header h1 i {
        color: var(--primary-accent-static);
        margin-right: 0.75rem;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }


      #main-content {
        display: flex;
        height: calc(100vh - var(--header-height));
        flex-grow: 1;
      }

      #controls-sidebar {
        width: var(--sidebar-width);
        background: var(--medium-bg);
        border-right: 1px solid var(--light-bg);
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      #map-container {
        flex: 1;
        position: relative;
        background: #0a0a0a;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .control-card {
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard);
        box-shadow: var(--modern-shadow);
        transition: transform var(--transition-speed) var(--transition-timing), box-shadow var(--transition-speed) var(--transition-timing);
      }
      .control-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 28px rgba(0,0,0,0.35), 0 2px 5px rgba(0,0,0,0.2), 0 0 0 1px var(--lighter-bg);
      }

      .control-card .card-header {
        font-size: 0.9rem;
        font-weight: var(--font-weight-medium);
        background-color: transparent;
        color: var(--text-muted-color);
        border-bottom: 1px solid var(--light-bg);
        padding: 0.6rem 1rem;
        display: flex;
        align-items: center;
        letter-spacing: 0.03em;
        text-transform: uppercase;
      }
      .control-card .card-header i {
        margin-right: 0.4rem;
        font-size: 0.9em;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }

      .control-card .card-body {
        padding: 0.8rem 1rem;
      }
      .control-card .card-header + .card-body {
        padding-top: 1rem;
      }

      p, .form-check-label, .legend-item span {
        line-height: 1.65;
        font-size: 0.85rem;
      }
      #narrative-panel .card-body p#narrative-text-element {
          line-height: 1.65;
          font-size: 0.85rem;
          color: var(--text-color) !important;
      }


      #current-period-display {
        font-size: 1.25rem;
        font-weight: var(--font-weight-bold);
        margin-top: 0.1rem;
        margin-bottom: 0.25rem;
        text-align: center;
        color: var(--timeline-period-color);
      }

      #timeline-value-display {
        font-weight: var(--font-weight-regular);
        font-size: 0.8rem;
        color: var(--text-muted-color);
        display: block;
        text-align: center;
        margin-bottom: 0.75rem;
      }

      #timeline-scrubber {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: var(--light-bg);
        outline: none;
        margin: 0.75rem 0;
        transition: background-color var(--transition-speed) var(--transition-timing);
      }
      #timeline-scrubber::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-accent-static);
        border: 2px solid var(--dark-bg);
        cursor: pointer;
        box-shadow: 0 0 8px var(--focus-ring-color);
        transition: transform 0.1s ease-out, background-color var(--transition-speed) var(--transition-timing);
      }
      #timeline-scrubber::-webkit-slider-thumb:hover {
        transform: scale(1.15);
      }
      #timeline-scrubber::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-accent-static);
        cursor: pointer;
        border: 2px solid var(--dark-bg);
        box-shadow: 0 0 8px var(--focus-ring-color);
        transition: transform 0.1s ease-out, background-color var(--transition-speed) var(--transition-timing);
      }
      #timeline-scrubber::-moz-range-thumb:hover {
        transform: scale(1.15);
      }

      .timeline-buttons .btn,
      .quick-filter-buttons .btn {
        border-radius: var(--border-radius-pill);
        padding: 0.35rem 0.85rem;
        font-size: 0.8rem;
        font-weight: var(--font-weight-medium);
        transition: background var(--transition-speed) var(--transition-timing),
                    color var(--transition-speed) var(--transition-timing),
                    border-color var(--transition-speed) var(--transition-timing),
                    filter var(--transition-speed) var(--transition-timing),
                    box-shadow var(--transition-speed) var(--transition-timing);
        border: 1px solid var(--light-bg);
        margin-top: 0.25rem;
      }
      .timeline-buttons .btn i,
      #reset-button i {
        margin-right: 0.35rem;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }
      .timeline-buttons .btn:hover i,
      #reset-button:hover i {
          transform: scale(1.1);
      }
      .timeline-buttons .btn-group { margin-top: 0.25rem; }


      #play-pause-button,
      .timeline-buttons .speed-btn.active,
      .quick-filter-buttons .btn.active {
          background: var(--primary-accent-gradient);
          border-color: transparent;
          color: var(--text-heading-color);
          box-shadow: var(--card-element-shadow);
      }
      #play-pause-button:hover,
      .timeline-buttons .speed-btn.active:hover,
      .quick-filter-buttons .btn.active:hover {
          filter: brightness(110%);
          box-shadow: 0 4px 12px var(--focus-ring-color);
      }

      .btn-outline-light {
          color: var(--text-muted-color);
          border-color: var(--light-bg);
          background-color: transparent;
      }
      .btn-outline-light:hover,
      .btn-outline-light.active {
          color: var(--text-heading-color); 
          background-color: var(--primary-accent-static); 
          border-color: var(--primary-accent-static);
      }
      .quick-filter-buttons .btn.active,
      .timeline-buttons .speed-btn.active {
          background: var(--primary-accent-gradient); 
          border-color: transparent;
          color: var(--text-heading-color);
      }
      .quick-filter-buttons .btn.active:hover,
      .timeline-buttons .speed-btn.active:hover {
        filter: brightness(110%);
        box-shadow: 0 4px 12px var(--focus-ring-color);
      }


      #reset-button {
          background-color: var(--danger-accent);
          border-color: var(--danger-accent);
          color: white;
          box-shadow: var(--card-element-shadow);
      }
      #reset-button:hover {
          filter: brightness(110%);
          box-shadow: 0 4px 12px rgba(var(--danger-accent-rgb), 0.5);
      }
      
      #period-filter-select {
        background-color: var(--dark-bg);
        color: var(--text-color);
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-pill);
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
        font-size: 0.8rem;
        font-weight: var(--font-weight-medium);
        transition: border-color var(--transition-speed) var(--transition-timing), 
                    box-shadow var(--transition-speed) var(--transition-timing);
      }
      #period-filter-select:focus {
        border-color: var(--primary-accent-static);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
        background-color: var(--dark-bg); 
        color: var(--text-color);
      }
      #period-filter-select option {
        background-color: var(--medium-bg);
        color: var(--text-color);
      }


      #species-filter-list {
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard);
        padding: 0.5rem;
        margin-top: 0.5rem;
        background-color: var(--dark-bg);
      }
      #species-filter-list .form-check {
        padding: 0.4rem 0.6rem;
        border-bottom: 1px solid var(--light-bg);
        display: flex;
        align-items: center;
        transition: background-color var(--transition-speed) var(--transition-timing);
        border-radius: 4px;
      }
      #species-filter-list .form-check:hover {
        background-color: var(--lighter-bg);
      }
      #species-filter-list .form-check:last-child {
        border-bottom: none;
      }
      #species-filter-list .form-check-label {
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 0.5rem;
        color: var(--text-color);
      }

      #species-filter-list .form-check-input {
        appearance: none;
        -webkit-appearance: none;
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
        border-radius: 4px;
        width: 1.1em;
        height: 1.1em;
        position: relative;
        cursor: pointer;
        transition: background var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing);
        margin-top: 0.15em;
        flex-shrink: 0;
      }
      #species-filter-list .form-check-input:checked {
        background: var(--primary-accent-gradient);
        border-color: transparent;
      }
      #species-filter-list .form-check-input:checked::before {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8em;
        color: white;
        font-weight: bold;
      }

      .species-color-indicator {
        width: 12px;
        height: 12px;
        display: inline-block;
        margin-left: 0.5rem;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      #narrative-panel .card-body {
        color: var(--text-color);
        overflow-y: auto;
      }
      #narrative-panel .card-body strong {
        color: var(--timeline-period-color);
        font-weight: var(--font-weight-medium);
      }
       #narrative-text-element {
        color: var(--text-color) !important;
      }

      .data-limitation-note {
        color: var(--warning-accent);
        font-size: 0.78rem;
        padding-top: 0.6rem;
        margin-top: 0.75rem;
        background-color: rgba(var(--warning-accent-rgb), 0.05);
        padding: 0.5rem;
        border-radius: 4px;
        border-top: none; 
      }
      .data-limitation-note i {
        margin-right: 0.35rem;
        color: var(--warning-accent);
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }

      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 0.75rem 1rem;
        background: rgba(var(--medium-bg-rgb), 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: var(--modern-shadow);
        border-radius: var(--border-radius-standard);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        color: var(--text-color);
      }
      .legend h5 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: var(--font-weight-medium);
        color: var(--text-heading-color);
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 0.4rem;
      }
      .legend h5 i {
        font-size: 0.85em;
        margin-right: 0.25rem;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.3rem;
        padding: 0.1rem 0;
      }
      .legend-color-box {
        width: 12px;
        height: 12px;
        margin-right: 5px;
        border: none;
        opacity: 1;
        flex-shrink: 0;
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
      }

      .loading-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(var(--dark-bg-rgb), 0.95);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
      }
      .loading-overlay .spinner-border {
        display: none;
      }
      .loading-overlay::before {
        content: "";
        display: block;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 4px solid var(--light-bg);
        border-top-color: var(--primary-accent-static);
        animation: customSpinner 0.8s linear infinite;
        margin-bottom: 1.5rem;
      }
      @keyframes customSpinner { to { transform: rotate(360deg); } }
      .loading-overlay p {
        margin-top: 0;
        margin-bottom: 0;
        font-size: 1.1rem;
        font-weight: var(--font-weight-light);
        letter-spacing: 0.05em;
        color: var(--text-color);
      }

      .climate-toggle-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--medium-bg);
        padding: 0.4rem 0.6rem;
        border-radius: var(--border-radius-standard);
        z-index: 1000;
        box-shadow: var(--modern-shadow);
        border: 1px solid var(--light-bg);
      }
      .climate-toggle-container .form-check-label {
        font-size: 0.75rem;
        color: var(--text-muted-color);
      }
      .climate-toggle-container .form-check-input {
        border-color: var(--primary-accent-static);
        background-color: var(--medium-bg);
      }
      .climate-toggle-container .form-check-input:checked {
        background-color: var(--primary-accent-static);
        border-color: var(--primary-accent-static);
      }


      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        background-color: var(--medium-bg) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--light-bg) !important;
        border-radius: var(--border-radius-standard) !important;
        box-shadow: var(--card-element-shadow) !important;
        transition: background-color var(--transition-speed) var(--transition-timing) !important;
      }
      .leaflet-control-zoom-in:hover,
      .leaflet-control-zoom-out:hover {
        background-color: var(--light-bg) !important;
      }

      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: var(--medium-bg);
        color: var(--text-color);
        box-shadow: var(--modern-shadow);
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard);
      }
      .leaflet-popup-content-wrapper { padding: 1px; } 
      .leaflet-popup-content { 
        padding: 0.8rem 1rem;
        font-size: 0.85rem;
        line-height: 1.6;
        margin: 0 !important;
      }
      .leaflet-popup-content h5 {
        margin-top: 0;
        margin-bottom: 0.6rem;
        font-size: 1.1em;
        font-weight: var(--font-weight-medium);
        color: var(--primary-accent-static);
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 0.4rem;
      }
       .leaflet-popup-content h5 i { /* Icon styling within popup title */
        margin-right: 0.3em;
        color: inherit; /* Inherit color from h5, or set specifically */
      }
      .popup-hr { /* Styling for HR in popups */
        margin: 0.3rem 0;
        border-color: var(--light-bg); 
        border-top-width: 1px;
        opacity: 0.5;
      }

      .leaflet-container a.leaflet-popup-close-button {
        color: var(--text-muted-color);
        padding: 8px 8px 0 0;
        transition: color var(--transition-speed) var(--transition-timing);
      }
      .leaflet-container a.leaflet-popup-close-button:hover {
        color: var(--danger-accent);
      }
      .popup-species-image {
        max-height: 100px;
        width: auto;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard); 
      }
      .popup-learn-more {
        color: var(--primary-accent-static);
        text-decoration: none;
        font-weight: var(--font-weight-medium);
      }
      .popup-learn-more:hover {
        color: var(--primary-accent-end);
        text-decoration: underline;
      }
      .popup-learn-more i {
        font-size: 0.8em;
        margin-left: 0.2em;
      }

      /* Focus States */
      *:focus-visible {
        outline: 2px solid var(--focus-ring-color);
        outline-offset: 2px;
      }
      #species-filter-list .form-check-input:focus-visible,
      #period-filter-select:focus-visible {
        box-shadow: 0 0 0 2px var(--dark-bg), 0 0 0 4px var(--focus-ring-color);
      }
      .tooltip-inner {
        background-color: var(--primary-accent-static);
        color: var(--text-heading-color);
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
      .tooltip .tooltip-arrow::before {
        border-top-color: var(--primary-accent-static) !important; 
        border-bottom-color: var(--primary-accent-static) !important;
        border-left-color: var(--primary-accent-static) !important;
        border-right-color: var(--primary-accent-static) !important;
      }

      /* Responsive Adjustments */
      @media (max-width: 992px) {
        #main-content { flex-direction: column; }
        #controls-sidebar {
          width: 100%;
          max-height: 45vh; 
          border-right: none;
          border-bottom: 1px solid var(--light-bg);
        }
        #map-container { flex-grow: 1; height: auto; }
      }

      @media (max-width: 767.98px) {
        header.app-header h1 { font-size: 1.3rem; }
        header.app-header h1 i { margin-right: 0.5rem; }

        #controls-sidebar { padding: 0.75rem; gap: 0.75rem; max-height: 50vh; }
        .control-card .card-header { font-size: 0.8rem; padding: 0.5rem 0.75rem; }
        .control-card .card-body { padding: 0.6rem 0.75rem; }
        #current-period-display { font-size: 1.1rem; }
        #timeline-value-display { font-size: 0.7rem; margin-bottom: 0.5rem; }
        #timeline-scrubber { margin: 0.5rem 0; }
        #timeline-scrubber::-webkit-slider-thumb { width: 18px; height: 18px; }
        #timeline-scrubber::-moz-range-thumb { width: 18px; height: 18px; }
        .timeline-buttons .btn, .quick-filter-buttons .btn, #reset-button { padding: 0.3rem 0.75rem; font-size: 0.75rem; }
        .timeline-buttons .btn i, #reset-button i { margin-right: 0.25rem; }
        #period-filter-select { font-size: 0.75rem; padding-top: 0.3rem; padding-bottom: 0.3rem; }
        #species-filter-list .form-check-label { font-size: 0.75rem; }
        #species-filter-list .form-check-input { width: 1em; height: 1em; }
        #species-filter-list .form-check-input:checked::before { font-size: 0.7em; }
        .species-color-indicator { width: 10px; height: 10px; }
        #narrative-panel .card-body, #narrative-panel .card-body p#narrative-text-element, .data-limitation-note { font-size: 0.75rem; }
        .legend { padding: 0.5rem 0.75rem; max-height: 150px; }
        .legend h5 { font-size: 0.8rem; }
        .legend-item { font-size: 0.7rem; }
        .legend-color-box { width: 10px; height: 10px; }
        .leaflet-popup-content { padding: 0.6rem 0.8rem; font-size: 0.75rem; }
        .leaflet-popup-content h5 { font-size: 1em; }
      }

      @media (max-width: 575.98px) {
        header.app-header { padding: 0 1rem; }
        header.app-header h1 { font-size: 1.15rem; }
        header.app-header h1 i { font-size: 0.9em; }
        #controls-sidebar { padding: 0.5rem; gap: 0.5rem; }
        .control-card .card-header { font-size: 0.75rem; padding: 0.4rem 0.6rem; }
        .control-card .card-header i { font-size: 0.85em; }
        .control-card .card-body { padding: 0.5rem 0.6rem; }
        .control-card .card-header + .card-body { padding-top: 0.75rem; }
        #current-period-display { font-size: 1rem; }
        .timeline-buttons { flex-wrap: wrap; gap: 0.25rem; }
        .d-flex.justify-content-between.align-items-center.mt-2.timeline-buttons > * {
            flex-basis: calc(33.333% - 0.2rem); 
            min-width: 70px; /* Further reduced min-width */
        }
        .timeline-buttons .btn-group { display: flex; }
        .timeline-buttons .btn-group .btn { flex-grow: 1; }
        .quick-filter-buttons .btn { font-size: 0.7rem; padding: 0.25rem 0.5rem; }
        #species-filter-list { max-height: 120px; }
        #narrative-panel .card-body, #narrative-panel .card-body p#narrative-text-element, .data-limitation-note { font-size: 0.7rem; }
        .data-limitation-note i { display: none; }
      }

    </style>
<meta content="images/human-evolution.png" property="og:image"/><meta content="images/human-evolution.png" name="twitter:image"/></head>
<body>
<div class="loading-overlay" id="loading-screen">
<p class="mt-2 mb-0">Loading Evolution Data...</p>
</div>
<header class="app-header">
<h1><i class="bi bi-globe-americas"></i> Human Evolution: Journey Through Time</h1>
</header>
<div id="main-content">
<aside id="controls-sidebar">
<div class="d-none h-100 d-flex flex-column" id="controls-content">
<div class="control-card card">
<div class="card-header"><i class="bi bi-clock-history"></i> Timeline Control</div>
<div class="card-body">
<div id="current-period-display">Data not loaded.</div>
<span id="timeline-value-display"></span>
<input class="form-range" data-bs-toggle="tooltip" disabled="" id="timeline-scrubber" min="0" title="Drag to select a time period" type="range" value="0"/>
<div class="d-flex justify-content-between align-items-center mt-2 timeline-buttons">
<button class="btn btn-sm" data-bs-placement="top" data-bs-toggle="tooltip" disabled="" id="play-pause-button" title="Play or Pause animation">
<i class="bi bi-play-fill"></i> <span>Play</span>
</button>
<div class="btn-group btn-group-sm" data-bs-toggle="tooltip" role="group" title="Adjust animation speed">
<button class="btn btn-outline-light speed-btn" data-speed="1" type="button">1x</button>
<button class="btn btn-outline-light speed-btn" data-speed="2" type="button">2x</button>
<button class="btn btn-outline-light speed-btn" data-speed="5" type="button">5x</button>
</div>
<button class="btn btn-sm" data-bs-toggle="tooltip" disabled="" id="reset-button" title="Reset timeline to start">
<i class="bi bi-arrow-clockwise"></i> Reset
                </button>
</div>
</div>
</div>
<div class="control-card card">
<div class="card-header"><i class="bi bi-collection-play"></i> Period Navigator</div>
<div class="card-body">
<label class="form-label visually-hidden" for="period-filter-select">Select a Time Period</label>
<select class="form-select" data-bs-toggle="tooltip" id="period-filter-select" title="Jump to a specific period">
<option disabled="" selected="" value="">Select a period...</option>
</select>
</div>
</div>
<div class="control-card card">
<div class="card-header"><i class="bi bi-people-fill"></i> Species Filter</div>
<div class="card-body">
<div class="btn-group btn-group-sm mb-2 quick-filter-buttons" role="group">
<button class="btn btn-outline-light" data-bs-toggle="tooltip" id="filter-all" title="Show all species">
                  All
                </button>
<button class="btn btn-outline-light" data-bs-toggle="tooltip" id="filter-none" title="Hide all species">
                  None
                </button>
<button class="btn btn-outline-light" data-bs-toggle="tooltip" id="filter-homo" title="Show only Homo genus">
                  Homo
                </button>
</div>
<div id="species-filter-list">
<p class="text-muted p-2 small">No species data loaded.</p>
</div>
</div>
</div>
<div class="control-card card flex-grow-1 mb-0" id="narrative-panel">
<div class="card-header"><i class="bi bi-book-half"></i> Period Overview</div>
<div class="card-body">
<p id="narrative-text-element">Select a time period to see an overview.</p>
<p class="data-limitation-note">
<i class="bi bi-exclamation-triangle-fill"></i> Note: Geographic map display depends on data in the
                fetched dataset. Active species are listed in the legend.
              </p>
</div>
</div>
</div>
</aside>
<main id="map-container">
<div id="map"></div>
<div class="climate-toggle-container">
<div class="form-check form-switch">
<input class="form-check-input" data-bs-toggle="tooltip" id="climate-toggle-switch" role="switch" title="Toggle Last Glacial Maximum ice sheets" type="checkbox"/>
<label class="form-check-label" for="climate-toggle-switch">Ice Sheets</label>
</div>
</div>
<div class="legend" id="legend">
<h5><i class="bi bi-palette"></i> Legend</h5>
<div id="legend-items-container"><small class="text-muted">Data not loaded.</small></div>
</div>
</main>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // --- State & Config ---
        let timePeriodsData = [];
        let fetchedIceSheetGeoJson = null;
        const map = L.map('map', { worldCopyJump: true, zoomControl: false }).setView([20, 40], 2);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd', maxZoom: 19
        }).addTo(map);
    
        let iceSheetLayerGroup = L.layerGroup();
        let speciesGeoJsonLayerGroup = L.layerGroup().addTo(map);
        let fossilSiteLayerGroup = L.layerGroup().addTo(map); // Layer for fossil markers
    
        let currentPeriodIndex = 0;
        let selectedSpecies = {};
        let allSpeciesList = [];
        let isPlaying = false;
        let animationFrameId;
        let lastFrameTime = 0;
        let playbackSpeed = 1; 
        const baseAnimationInterval = 3500; 
    
        const domElements = {
            timelineScrubber: null,
            currentPeriodDisplay: null,
            timelineValueDisplay: null,
            speciesFilterList: null,
            legendItemsContainer: null,
            playPauseButton: null,
            playPauseIcon: null, 
            playPauseText: null, 
            resetButton: null,
            narrativeTextElement: null,
            loadingScreen: null,
            controlsContentDiv: null,
            climateToggle: null,
            periodFilterSelect: null 
        };
    
        function populateDomElements() {
            const idMap = {
                controlsContentDiv: 'controls-content',
                climateToggle: 'climate-toggle-switch',
                periodFilterSelect: 'period-filter-select' 
            };
            for (const key in domElements) {
                if (key === 'playPauseIcon' || key === 'playPauseText') continue;
                const elementId = idMap[key] || key.replace(/([A-Z])/g, '-$1').toLowerCase();
                domElements[key] = document.getElementById(elementId);
                if (!domElements[key]) {
                    console.warn(`DOM element with ID '${elementId}' (for key '${key}') not found.`);
                }
            }
            if (domElements.playPauseButton) {
                domElements.playPauseIcon = domElements.playPauseButton.querySelector('i');
                domElements.playPauseText = domElements.playPauseButton.querySelector('span');
            } else {
                console.error("playPauseButton element not found, cannot derive icon and text elements.");
            }
        }
    
        async function fetchAllRequiredData() {
            try {
                if (domElements.loadingScreen) {
                     domElements.loadingScreen.style.display = 'flex'; 
                     domElements.loadingScreen.querySelector('p').textContent = 'Loading Evolution Data...';
                }

                const [evolutionResponse, iceSheetResponse] = await Promise.all([
                    fetch('https://cheatsheets.davidveksler.com/evolution_data.json'), // Ensure this path is correct
                    fetch('https://cheatsheets.davidveksler.com/iceSheetGeoJson.json') // Ensure this path is correct
                ]);

                if (!evolutionResponse.ok) throw new Error(`HTTP error! status: ${evolutionResponse.status} for evolution data`);
                if (!iceSheetResponse.ok) throw new Error(`HTTP error! status: ${iceSheetResponse.status} for ice sheet data`);

                timePeriodsData = await evolutionResponse.json();
                fetchedIceSheetGeoJson = await iceSheetResponse.json(); 

                if (!Array.isArray(timePeriodsData) || timePeriodsData.length === 0) throw new Error("Fetched evolution data is not a valid array or is empty.");
                if (typeof fetchedIceSheetGeoJson !== 'object' || fetchedIceSheetGeoJson === null) throw new Error("Fetched ice sheet data is not a valid object.");

                // Sort timePeriodsData chronologically
                timePeriodsData.sort((a, b) => {
                    if (a.numericStartYear == null || b.numericStartYear == null) { 
                        console.warn("Data integrity: Found period(s) without numericStartYear. Sorting may be affected.");
                        return 0; 
                    }
                    return a.numericStartYear - b.numericStartYear;
                });

                initializeApplication();
            } catch (error) {
                console.error("Could not fetch initial data:", error);
                if (domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.innerHTML = "<strong class='text-danger'>Error loading data.</strong>";
                if (domElements.loadingScreen) {
                     domElements.loadingScreen.style.display = 'flex'; 
                     domElements.loadingScreen.innerHTML = `<div class='p-3 text-center'><i class='bi bi-exclamation-triangle-fill text-danger h1'></i><p class="text-light">Failed to load required data.<br><small>${error.message}</small></p></div>`;
                }
            }
            // The redundant try...catch block that was here has been removed.
        }
    
        function populatePeriodFilter() {
            if (!domElements.periodFilterSelect || !timePeriodsData || timePeriodsData.length === 0) {
                if (domElements.periodFilterSelect) domElements.periodFilterSelect.disabled = true;
                return;
            }
            domElements.periodFilterSelect.disabled = false;
            domElements.periodFilterSelect.innerHTML = ''; 

            const defaultOption = document.createElement('option');
            defaultOption.textContent = 'Select a period...';
            defaultOption.value = ""; 
            defaultOption.disabled = true;
            domElements.periodFilterSelect.appendChild(defaultOption);

            timePeriodsData.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = period.periodName || `Period ${index + 1}`;
                domElements.periodFilterSelect.appendChild(option);
            });
        }
    
        function initializeApplication() {
            if (!domElements.loadingScreen || !domElements.controlsContentDiv) {
                document.body.innerHTML = `<div class='p-5 text-center text-danger'><h1>Application Error</h1><p>Essential UI components are missing.</p></div>`;
                return;
            }

            domElements.loadingScreen.style.display = 'none';
            domElements.controlsContentDiv.classList.remove('d-none');

            Object.keys(domElements).forEach(key => {
                const el = domElements[key];
                if (el && el.id !== 'period-filter-select' && typeof el.disabled === 'boolean') {
                    el.disabled = false;
                }
            });
            if (domElements.timelineScrubber) domElements.timelineScrubber.max = timePeriodsData.length - 1;

            populateAllSpeciesList();
            populateSpeciesFilter();
            populatePeriodFilter(); 
            currentPeriodIndex = 0;
            updateSpeedButtonsActiveState(); 
            updateQuickFilterActiveState('filter-all'); 
            updateUIForCurrentPeriod();

            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    
        function populateAllSpeciesList() {
            const speciesSet = new Map();
            timePeriodsData.forEach(period => {
                (period.species || []).forEach(s => {
                    if (s && s.name && !speciesSet.has(s.name)) { 
                        speciesSet.set(s.name, { color: s.color || '#cccccc' }); 
                    }
                });
            });
            allSpeciesList = Array.from(speciesSet, ([name, data]) => ({ name, ...data }));
            allSpeciesList.sort((a, b) => a.name.localeCompare(b.name));
        }
    
        function populateSpeciesFilter() {
            domElements.speciesFilterList.innerHTML = '';
            if (allSpeciesList.length === 0) {
                domElements.speciesFilterList.innerHTML = '<p class="text-muted p-2 small">No species data.</p>'; return;
            }
            allSpeciesList.forEach(s => {
                selectedSpecies[s.name] = true; 
                const itemDiv = document.createElement('div'); itemDiv.className = 'form-check';
                const input = document.createElement('input');
                input.type = 'checkbox'; input.className = 'form-check-input';
                input.id = `filter-${s.name.replace(/\W/g, '_')}`; input.value = s.name; input.checked = true;
                input.addEventListener('change', (event) => {
                    selectedSpecies[event.target.value] = event.target.checked;
                    updateUIForCurrentPeriod(); 
                    updateQuickFilterActiveState(null); 
                });
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'species-color-indicator'; colorIndicator.style.backgroundColor = s.color;
                const label = document.createElement('label');
                label.className = 'form-check-label'; label.htmlFor = input.id; label.textContent = s.name;
                itemDiv.appendChild(input); itemDiv.appendChild(colorIndicator); itemDiv.appendChild(label);
                domElements.speciesFilterList.appendChild(itemDiv);
            });
        }
    
        function updateUIForCurrentPeriod() {
            speciesGeoJsonLayerGroup.clearLayers();
            fossilSiteLayerGroup.clearLayers(); 
    
            if (!timePeriodsData || timePeriodsData.length === 0 || currentPeriodIndex < 0 || currentPeriodIndex >= timePeriodsData.length) {
                if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = `Timeline End`;
                if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = "(Drag or Reset)";
                if(domElements.narrativeTextElement) domElements.narrativeTextElement.textContent = "End of timeline.";
                if(domElements.legendItemsContainer) domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No period.</small>';
                if(domElements.periodFilterSelect) domElements.periodFilterSelect.value = ""; 
                return;
            }
    
            const period = timePeriodsData[currentPeriodIndex];
            if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = period.periodName || "Unknown";
            if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = period.timeRange || `Period ${currentPeriodIndex + 1}`;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = currentPeriodIndex;
            if (domElements.periodFilterSelect) domElements.periodFilterSelect.value = currentPeriodIndex;
            if(domElements.narrativeTextElement) domElements.narrativeTextElement.innerHTML = period.narrative || "No narrative.";
    
            let speciesInCurrentPeriod = period.species || [];
            let visibleSpeciesInLegend = [];
    
            speciesInCurrentPeriod.forEach(s => {
                if (s && s.name && selectedSpecies[s.name]) {
                    visibleSpeciesInLegend.push(s); 
    
                    let speciesImage = s.imageUrl ? `<img src="${s.imageUrl}" alt="${s.name}" class="img-fluid rounded mb-2 popup-species-image">` : '';
                    let learnMoreLink = s.learnMoreUrl ? `<p class="mb-1 mt-1 small"><a href="${s.learnMoreUrl}" target="_blank" rel="noopener noreferrer" class="popup-learn-more">Learn More <i class="bi bi-box-arrow-up-right"></i></a></p>` : '';
                    let speciesRangePopupContent = `<h5>${s.name}</h5>${speciesImage}<p class="mb-1 small"><strong>Timeline:</strong> ${s.timeline||'N/A'}</p><p class="mb-0 small">${s.notes||'No notes.'}</p>${learnMoreLink}`;
    
                    if (s.estimatedRangeGeoJson && Object.keys(s.estimatedRangeGeoJson).length > 0) {
                        try {
                            L.geoJSON(s.estimatedRangeGeoJson, { style: { fillColor: s.color||'#888', weight:1.5, opacity:1, color:'rgba(255,255,255,0.3)', fillOpacity:0.55 }})
                             .bindPopup(speciesRangePopupContent).addTo(speciesGeoJsonLayerGroup);
                        } catch (e) { console.warn("Error drawing range for", s.name, e); }
                    }
    
                    if (s.migrationPaths && Array.isArray(s.migrationPaths)) {
                        s.migrationPaths.forEach(path => {
                            if (path && Object.keys(path).length > 0) {
                               try { L.geoJSON(path, { style: { color:s.migrationColor||s.color||'#888', weight:3, opacity:0.75, dashArray:'8, 6', lineCap:'round' }})
                                     .bindPopup(speciesRangePopupContent).addTo(speciesGeoJsonLayerGroup); } catch (e) { console.warn("Error drawing migration for", s.name, e); }
                            }
                        });
                    }

                    // Plot Fossil Site Markers
                    if (s.locations && Array.isArray(s.locations)) {
                        s.locations.forEach(loc => {
                            if (loc.latitude != null && loc.longitude != null) {
                                const markerCertainty = loc.certainty || 0.7;
                                const markerOptions = {
                                    radius: 5,
                                    fillColor: "var(--timeline-period-color)", // Amber
                                    color: s.color || "var(--light-bg)",      
                                    weight: 1.5,                              
                                    opacity: 1,
                                    fillOpacity: 0.6 + (markerCertainty * 0.3)
                                };
                                let fossilPopupContent = `<h5><i class="bi bi-compass"></i> ${loc.siteName}</h5>
                                                          <p class="mb-1 small">${loc.details}</p>
                                                          <hr class="popup-hr">
                                                          <p class="mb-0 small"><strong>Found:</strong> ${s.name}</p>
                                                          ${loc.certainty ? `<p class="mb-0 small"><strong>Discovery Certainty:</strong> ${(markerCertainty * 100).toFixed(0)}%</p>` : ''}`;
                                L.circleMarker([loc.latitude, loc.longitude], markerOptions)
                                    .bindPopup(fossilPopupContent)
                                    .addTo(fossilSiteLayerGroup);
                            }
                        });
                    }
                }
            });
            updateLegend(visibleSpeciesInLegend);
            updateClimateOverlay(period);
        }
    
        function updateLegend(visibleSpecies) {
            if (!domElements.legendItemsContainer) return;
            domElements.legendItemsContainer.innerHTML = '';
            if (visibleSpecies.length === 0) {
                domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No species selected or in period.</small>'; return;
            }
            visibleSpecies.sort((a,b) => a.name.localeCompare(b.name));
            visibleSpecies.forEach(s => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'legend-item';
                const colorBox = document.createElement('span');
                colorBox.className = 'legend-color-box'; colorBox.style.backgroundColor = s.color || '#cccccc';
                const nameSpan = document.createElement('span'); nameSpan.textContent = s.name;
                itemDiv.appendChild(colorBox); itemDiv.appendChild(nameSpan);
                domElements.legendItemsContainer.appendChild(itemDiv);
            });
        }
    
        function parseYearFromRange(rangeString) {
            if (!rangeString) return { start: null, end: null };
            const cleaned = rangeString.toLowerCase().replace(/c\.|ago|years|million|kya|mya/g, '').trim();
            const parts = cleaned.split(/\s*-\s*|\s+to\s+/);
            function parsePart(part) {
                part = part.trim(); let num = parseFloat(part.replace(/,/g, '')); 
                if (rangeString.toLowerCase().includes("million") || rangeString.toLowerCase().includes("mya")) num *= 1000000;
                else if (rangeString.toLowerCase().includes("kya")) num *= 1000;
                return isNaN(num) ? null : -Math.abs(num); 
            }
            let startYear = parsePart(parts[0]);
            let endYear = parts.length > 1 ? parsePart(parts[1]) : startYear;
            if (startYear && endYear === null) endYear = startYear; if (endYear && startYear === null) startYear = endYear;
            if (startYear && endYear && startYear > endYear) [startYear, endYear] = [endYear, startYear];
            return { start: startYear, end: endYear };
        }
    
        function updateClimateOverlay(period) { // Accepts the full period object
            iceSheetLayerGroup.clearLayers();
            // --- DEBUGGING START ---
            console.log("Attempting to update climate overlay.");
            if (domElements.climateToggle) {
                console.log("Climate Toggle Exists. Checked:", domElements.climateToggle.checked);
            } else {
                console.log("Climate Toggle DOM element NOT FOUND.");
                // Fallback or early exit if essential controls are missing
                return;
            }

            if (period) {
                console.log("Current Period:", period.periodName, 
                            "Numeric Start:", period.numericStartYear, 
                            "Numeric End:", period.numericEndYear);
            } else {
                console.log("Current Period object is null or undefined.");
            }

            if (!fetchedIceSheetGeoJson) {
                console.log("fetchedIceSheetGeoJson is null or not loaded.");
            }
            // --- DEBUGGING END ---

            if (domElements.climateToggle.checked && period &&
                period.numericStartYear != null && period.numericEndYear != null && // Ensure numeric years are present
                fetchedIceSheetGeoJson) {

                const currentPeriodStart = period.numericStartYear;
                const currentPeriodEnd = period.numericEndYear;

                const lgmStart = -26500; // Last Glacial Maximum start ~26,500 years ago
                const lgmEnd = -19000;   // Last Glacial Maximum end ~19,000 years ago

                // --- DEBUGGING START ---
                console.log(`Checking LGM overlap: Period (${currentPeriodStart} to ${currentPeriodEnd}) vs LGM (${lgmStart} to ${lgmEnd})`);
                // --- DEBUGGING END ---
                
                // Check for overlap: The LGM period must overlap with the current hominin period
                const isOverlap = Math.max(currentPeriodStart, lgmStart) <= Math.min(currentPeriodEnd, lgmEnd);

                // --- DEBUGGING START ---
                console.log("Is LGM overlapping with current period?", isOverlap);
                // --- DEBUGGING END ---

                if (isOverlap) {
                    // --- DEBUGGING START ---
                    console.log("Overlap with LGM detected. Adding ice sheets to layer group.");
                    let sheetsAddedCount = 0;
                    // --- DEBUGGING END ---
                    Object.values(fetchedIceSheetGeoJson).forEach(sheet => {
                        if (sheet && sheet.type && sheet.coordinates) {
                            try {
                                L.geoJSON(sheet, {
                                    style: {
                                        color: 'rgba(173,216,230,0.5)',
                                        fillColor: '#A2D1E6',
                                        fillOpacity: 0.35,
                                        weight: 1
                                    }
                                }).addTo(iceSheetLayerGroup);
                                // --- DEBUGGING START ---
                                sheetsAddedCount++;
                                // --- DEBUGGING END ---
                            } catch (e) {
                                console.warn("Error drawing ice sheet GeoJSON feature:", e, sheet);
                            }
                        } else {
                            console.warn("Invalid GeoJSON feature structure in ice sheet data:", sheet);
                        }
                    });
                    // --- DEBUGGING START ---
                    console.log(sheetsAddedCount + " ice sheet features processed.");
                    // --- DEBUGGING END ---
                }
            } else {
                // --- DEBUGGING START ---
                let conditionsNotMetReason = "Conditions for displaying ice sheets not met:";
                if (!domElements.climateToggle.checked) conditionsNotMetReason += " Toggle not checked.";
                if (!period) conditionsNotMetReason += " Period undefined.";
                else if (period.numericStartYear == null || period.numericEndYear == null) conditionsNotMetReason += " Numeric years missing in period.";
                if (!fetchedIceSheetGeoJson) conditionsNotMetReason += " Ice sheet data not fetched.";
                console.log(conditionsNotMetReason);
                // --- DEBUGGING END ---
            }

            // Add or remove the layer group from the map based on its content and toggle state
            if (domElements.climateToggle.checked && iceSheetLayerGroup.getLayers().length > 0) {
                if (!map.hasLayer(iceSheetLayerGroup)) {
                    map.addLayer(iceSheetLayerGroup);
                    console.log("iceSheetLayerGroup added to map.");
                }
            } else {
                if (map.hasLayer(iceSheetLayerGroup)) {
                    map.removeLayer(iceSheetLayerGroup);
                    console.log("iceSheetLayerGroup removed from map.");
                }
            }
        }
    
        function animationLoop(timestamp) {
            if (!isPlaying) return;
            if (timestamp - lastFrameTime >= (baseAnimationInterval / playbackSpeed)) {
                lastFrameTime = timestamp; currentPeriodIndex++;
                if (currentPeriodIndex >= timePeriodsData.length) { currentPeriodIndex = timePeriodsData.length - 1; pauseAnimation(); }
                updateUIForCurrentPeriod();
            }
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function playAnimation() {
            if (!timePeriodsData || timePeriodsData.length === 0) return;
            isPlaying = true;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-pause-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Pause";
            lastFrameTime = performance.now();
            if (currentPeriodIndex >= timePeriodsData.length - 1 && timePeriodsData.length > 0) currentPeriodIndex = 0;
            updateUIForCurrentPeriod(); 
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function pauseAnimation() {
            isPlaying = false;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-play-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Play";
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
        }
    
        function togglePlayPause() { if (isPlaying) pauseAnimation(); else playAnimation(); }
    
        function resetAnimation() {
            pauseAnimation(); currentPeriodIndex = 0;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = 0;
            playbackSpeed = 1; updateSpeedButtonsActiveState();
            if (allSpeciesList && allSpeciesList.length > 0) {
                 Object.keys(selectedSpecies).forEach(sName => { selectedSpecies[sName] = true; });
                 document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => { cb.checked = true; });
            }
            updateQuickFilterActiveState('filter-all'); 
            updateUIForCurrentPeriod(); 
        }
    
        function updateSpeedButtonsActiveState() {
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active'); btn.classList.add('btn-outline-light'); 
                if (parseInt(btn.dataset.speed) === playbackSpeed) { btn.classList.add('active'); btn.classList.remove('btn-outline-light'); }
            });
        }

        function updateQuickFilterActiveState(activeButtonId) {
            document.querySelectorAll('.quick-filter-buttons .btn').forEach(btn => {
                btn.classList.remove('active'); btn.classList.add('btn-outline-light'); 
            });
            if (activeButtonId) {
                const activeButton = document.getElementById(activeButtonId);
                if (activeButton) { activeButton.classList.add('active'); activeButton.classList.remove('btn-outline-light'); }
            }
        }
    
        function addEventListeners() {
            if (!domElements.timelineScrubber || !domElements.playPauseButton || !domElements.resetButton) return;
            domElements.timelineScrubber.addEventListener('input', (event) => {
                currentPeriodIndex = parseInt(event.target.value); pauseAnimation(); updateUIForCurrentPeriod();
            });
            domElements.playPauseButton.addEventListener('click', togglePlayPause);
            domElements.resetButton.addEventListener('click', resetAnimation);
    
            document.querySelectorAll('.speed-btn').forEach(button => {
                button.addEventListener('click', () => { playbackSpeed = parseInt(button.dataset.speed); updateSpeedButtonsActiveState(); });
            });
            ['filter-all', 'filter-none', 'filter-homo'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.addEventListener('click', () => {
                    if (id === 'filter-all') allSpeciesList.forEach(s => selectedSpecies[s.name] = true);
                    else if (id === 'filter-none') allSpeciesList.forEach(s => selectedSpecies[s.name] = false);
                    else if (id === 'filter-homo') allSpeciesList.forEach(s => selectedSpecies[s.name] = s.name.toLowerCase().includes('homo'));
                    
                    document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => {
                        cb.checked = selectedSpecies[cb.value];
                    });
                    updateUIForCurrentPeriod(); updateQuickFilterActiveState(id);
                });
            });

            if(domElements.climateToggle) domElements.climateToggle.addEventListener('change', () => {
                if (timePeriodsData.length > 0 && fetchedIceSheetGeoJson) updateUIForCurrentPeriod(); 
            });

            if (domElements.periodFilterSelect) domElements.periodFilterSelect.addEventListener('change', (event) => {
                const selectedIndex = parseInt(event.target.value);
                if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < timePeriodsData.length) {
                    currentPeriodIndex = selectedIndex; pauseAnimation(); updateUIForCurrentPeriod();
                }
            });
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            populateDomElements(); addEventListeners(); fetchAllRequiredData();
        });
        </script>
</body>
</html>