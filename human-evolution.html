<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Human Evolution: Journey Through Time (Concise)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      :root {
        --sidebar-width: 380px;
        --header-height: 60px;
        --primary-accent: #0d6efd;
        --danger-accent: #dc3545;
        --dark-bg: #161618;
        --medium-bg: #212124;
        --light-bg: #303033;
        --text-color: #f0f0f0;
        --text-muted-color: #d0d0d0;
        --timeline-period-color: #6cb2f7;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        overflow: hidden;
        background: var(--dark-bg);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header.app-header {
        height: var(--header-height);
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
      }

      header.app-header h1 {
        font-size: 1.4rem;
        font-weight: 300;
        margin: 0;
        letter-spacing: 0.5px;
      }

      #main-content {
        display: flex;
        height: calc(100vh - var(--header-height));
        flex-grow: 1;
      }

      #controls-sidebar {
        width: var(--sidebar-width);
        background: var(--medium-bg);
        border-right: 1px solid var(--light-bg);
        overflow-y: auto;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      @media (max-width: 992px) {
        #main-content {
          flex-direction: column;
        }

        #controls-sidebar {
          width: 100%;
          max-height: 45vh;
          border-right: none;
          border-bottom: 1px solid var(--light-bg);
        }

        #map-container {
          flex-grow: 1;
          height: auto;
        }
      }

      #map-container {
        flex: 1;
        position: relative;
        background: #0a0a0a;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .control-card {
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
        border-radius: 5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
      }

      .control-card .card-header {
        font-size: 0.85rem;
        font-weight: 500;
        background-color: var(--light-bg);
        color: var(--text-muted-color);
        border-bottom: 1px solid var(--light-bg);
        padding: 0.4rem 0.6rem;
        display: flex;
        align-items: center;
      }

      .control-card .card-header i {
        margin-right: 0.4rem;
        font-size: 0.9em;
      }

      .control-card .card-body {
        padding: 0.6rem;
      }

      #current-period-display {
        font-size: 1.15rem;
        font-weight: bold;
        margin-top: 0.1rem;
        margin-bottom: 0.05rem;
        text-align: center;
        color: var(--timeline-period-color);
      }

      #timeline-value-display {
        font-weight: normal;
        font-size: 0.7rem;
        color: var(--text-muted-color);
        display: block;
        text-align: center;
        margin-bottom: 0.5rem;
      }

      #timeline-scrubber {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #505050;
        outline: none;
        margin: 0.5rem 0;
      }

      #timeline-scrubber::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-accent);
        cursor: pointer;
        box-shadow: 0 0 4px rgba(var(--primary-accent), 0.6);
      }

      #timeline-scrubber::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-accent);
        cursor: pointer;
        border: none;
        box-shadow: 0 0 4px rgba(var(--primary-accent), 0.6);
      }

      .timeline-buttons .btn,
      .timeline-buttons .btn-group {
        margin-top: 0.25rem;
      }

      .timeline-buttons .btn {
        padding: 0.25rem 0.6rem;
        font-size: 0.8rem;
      }

      .timeline-buttons .btn i {
        margin-right: 0.25rem;
      }

      #reset-button {
        background-color: var(--danger-accent);
        border-color: var(--danger-accent);
        color: white;
      }

      #reset-button:hover {
        filter: brightness(90%);
      }

      .quick-filter-buttons .btn {
        margin-right: 0.25rem;
        font-size: 0.75rem;
        padding: 0.2rem 0.45rem;
      }

      .btn-outline-light {
        color: var(--text-muted-color);
        border-color: var(--light-bg);
      }

      .btn-outline-light:hover,
      .btn-outline-light.active {
        color: var(--dark-bg);
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
        font-weight: 500;
      }

      #species-filter-list {
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        border-radius: 4px;
        padding: 0.25rem;
        margin-top: 0.5rem;
      }

      #species-filter-list .form-check {
        padding: 0.2rem 0.4rem;
        border-bottom: 1px solid var(--light-bg);
        display: flex;
        align-items: center;
      }

      #species-filter-list .form-check:last-child {
        border-bottom: none;
      }

      #species-filter-list .form-check-label {
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 0.4rem;
        color: var(--text-color);
      }

      #species-filter-list .form-check-input {
        cursor: pointer;
        margin-top: 0;
        width: 0.9em;
        height: 0.9em;
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
      }

      #species-filter-list .form-check-input:checked {
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
      }

      .species-color-indicator {
        width: 10px;
        height: 10px;
        display: inline-block;
        margin-left: 0.3rem;
        border-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #narrative-panel .card-body {
        font-size: 0.8rem;
        line-height: 1.5;
        color: var(--text-color); /* This will be inherited by default */
        overflow-y: auto;
      }

      #narrative-panel .card-body strong { /* Style for <strong> tags if used in narrative */
        color: var(--timeline-period-color);
      }

       /* Ensure p#narrative-text-element specifically uses the desired color */
      #narrative-text-element {
        color: var(--text-color) !important; /* Override other specificities if needed */
      }


      .data-limitation-note {
        color: #ffc107;
        font-size: 0.75rem;
        margin-top: 0.5rem;
        border-top: 1px dashed var(--light-bg);
        padding-top: 0.5rem;
      }

      .data-limitation-note i {
        margin-right: 0.25rem;
      }

      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 0.5rem 0.75rem;
        background: rgba(30, 30, 32, 0.92);
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        z-index: 1000;
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        color: var(--text-color);
      }

      .legend h5 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 0.85rem;
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 3px;
      }

      .legend h5 i {
        font-size: 0.85em;
        margin-right: 0.25rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
        font-size: 0.7rem;
      }

      .legend-color-box {
        width: 10px;
        height: 10px;
        margin-right: 5px;
        border: 1px solid #777;
        opacity: 0.8;
        flex-shrink: 0;
        border-radius: 2px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex; /* Keep flex for centering spinner */
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        z-index: 9999;
        flex-direction: column;
      }

      .loading-overlay .spinner-border {
        width: 2.5rem;
        height: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .climate-toggle-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--medium-bg);
        padding: 0.4rem 0.6rem;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--light-bg);
      }

      .climate-toggle-container .form-check-label {
        font-size: 0.75rem;
        color: var(--text-muted-color);
      }

      .climate-toggle-container .form-check-input {
        border-color: var(--primary-accent);
      }

      .climate-toggle-container .form-check-input:checked {
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
      }

      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        background-color: var(--medium-bg) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--light-bg) !important;
        border-radius: 4px !important;
      }

      .leaflet-control-zoom-in:hover,
      .leaflet-control-zoom-out:hover {
        background-color: var(--light-bg) !important;
      }

      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: var(--medium-bg);
        color: var(--text-color);
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--light-bg);
      }

      .leaflet-popup-content h5 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.05em;
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 5px;
      }

      .leaflet-container a.leaflet-popup-close-button {
        color: var(--text-muted-color);
      }
    </style>
  </head>

  <body>
    <div id="loading-screen" class="loading-overlay">
      <div class="spinner-border text-light" role="status"></div>
      <p class="mt-2 mb-0">Loading Evolution Data...</p>
    </div>
    <header class="app-header">
      <h1><i class="bi bi-globe-americas"></i> Human Evolution: A Journey Through Time</h1>
    </header>
    <div id="main-content">
      <aside id="controls-sidebar">
        <div id="controls-content" class="d-none h-100 d-flex flex-column">
          <div class="control-card card">
            <div class="card-header"><i class="bi bi-clock-history"></i> Timeline Control</div>
            <div class="card-body">
              <div id="current-period-display">Data not loaded.</div>
              <span id="timeline-value-display"></span>
              <input
                type="range"
                class="form-range"
                id="timeline-scrubber"
                min="0"
                value="0"
                disabled
                data-bs-toggle="tooltip"
                title="Drag to select a time period"
              />
              <div class="d-flex justify-content-between align-items-center mt-2 timeline-buttons">
                <button
                  id="play-pause-button"
                  class="btn btn-primary btn-sm"
                  disabled
                  data-bs-toggle="tooltip"
                  title="Play or Pause animation"
                >
                  <i class="bi bi-play-fill"></i> <span>Play</span>
                </button>
                <div
                  class="btn-group btn-group-sm"
                  role="group"
                  data-bs-toggle="tooltip"
                  title="Adjust animation speed"
                >
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="1">1x</button>
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="2">2x</button>
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="5">5x</button>
                </div>
                <button
                  id="reset-button"
                  class="btn btn-danger btn-sm"
                  disabled
                  data-bs-toggle="tooltip"
                  title="Reset timeline to start"
                >
                  <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
              </div>
            </div>
          </div>
          <div class="control-card card">
            <div class="card-header"><i class="bi bi-people-fill"></i> Species Filter</div>
            <div class="card-body">
              <div class="btn-group btn-group-sm mb-2 quick-filter-buttons" role="group">
                <button class="btn btn-outline-light" id="filter-all" data-bs-toggle="tooltip" title="Show all species">
                  All
                </button>
                <button
                  class="btn btn-outline-light"
                  id="filter-none"
                  data-bs-toggle="tooltip"
                  title="Hide all species"
                >
                  None
                </button>
                <button
                  class="btn btn-outline-light"
                  id="filter-homo"
                  data-bs-toggle="tooltip"
                  title="Show only Homo genus"
                >
                  Homo
                </button>
              </div>
              <div id="species-filter-list">
                <p class="text-muted p-2 small">No species data loaded.</p>
              </div>
            </div>
          </div>
          <div id="narrative-panel" class="control-card card flex-grow-1 mb-0">
            <div class="card-header"><i class="bi bi-book-half"></i> Period Overview</div>
            <div class="card-body">
              <!-- MODIFICATION: Removed class="text-muted" -->
              <p id="narrative-text-element">Select a time period to see an overview.</p>
              <p class="data-limitation-note">
                <i class="bi bi-exclamation-triangle-fill"></i> Note: Geographic map display depends on data in the
                fetched dataset. Active species are listed in the legend.
              </p>
            </div>
          </div>
        </div>
      </aside>
      <main id="map-container">
        <div id="map"></div>
        <div class="climate-toggle-container">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="climate-toggle-switch"
              data-bs-toggle="tooltip"
              title="Toggle Last Glacial Maximum ice sheets"
            />
            <label class="form-check-label" for="climate-toggle-switch">Ice Sheets</label>
          </div>
        </div>
        <div id="legend" class="legend">
          <h5><i class="bi bi-palette"></i> Legend</h5>
          <div id="legend-items-container"><small class="text-muted">Data not loaded.</small></div>
        </div>
      </main>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   
    <script>
        // --- State & Config ---
        let timePeriodsData = [];
        let fetchedIceSheetGeoJson = null; // MODIFICATION: For fetched ice sheet data
        const map = L.map('map', { worldCopyJump: true, zoomControl: false }).setView([20, 40], 2);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd', maxZoom: 19
        }).addTo(map);
    
        let iceSheetLayerGroup = L.layerGroup();
        let speciesGeoJsonLayerGroup = L.layerGroup().addTo(map);
    
        let currentPeriodIndex = 0;
        let selectedSpecies = {};
        let allSpeciesList = [];
        let isPlaying = false;
        let animationFrameId;
        let lastFrameTime = 0;
        let playbackSpeed = 1; 
        const baseAnimationInterval = 3500; 
    
        const domElements = {
            timelineScrubber: null,
            currentPeriodDisplay: null,
            timelineValueDisplay: null,
            speciesFilterList: null,
            legendItemsContainer: null,
            playPauseButton: null,
            playPauseIcon: null, 
            playPauseText: null, 
            resetButton: null,
            narrativeTextElement: null,
            loadingScreen: null,
            controlsContentDiv: null,
            climateToggle: null
        };
    
        function populateDomElements() {
            const idMap = {
                controlsContentDiv: 'controls-content',
                climateToggle: 'climate-toggle-switch'
            };
            for (const key in domElements) {
                if (key === 'playPauseIcon' || key === 'playPauseText') continue;
                const elementId = idMap[key] || key.replace(/([A-Z])/g, '-$1').toLowerCase();
                domElements[key] = document.getElementById(elementId);
                if (!domElements[key]) {
                    console.warn(`DOM element with ID '${elementId}' (for key '${key}') not found.`);
                }
            }
            if (domElements.playPauseButton) {
                domElements.playPauseIcon = domElements.playPauseButton.querySelector('i');
                domElements.playPauseText = domElements.playPauseButton.querySelector('span');
                if (!domElements.playPauseIcon) console.warn("Play/Pause button icon (<i>) not found.");
                if (!domElements.playPauseText) console.warn("Play/Pause button text (<span>) not found.");
            } else {
                console.error("playPauseButton element not found, cannot derive icon and text elements.");
            }
        }
    
        // MODIFICATION: Removed large hardcoded iceSheetGeoJson object
    
        // --- Core Functions ---
        // MODIFICATION: Renamed and updated to fetch both JSON files
        async function fetchAllRequiredData() {
            try {
                // Ensure loading screen is visible if it wasn't already (e.g. if it was hidden by an error previously)
                if (domElements.loadingScreen) {
                     domElements.loadingScreen.style.display = 'flex'; // Ensure it's 'flex' as per CSS
                     domElements.loadingScreen.innerHTML = `<div class="spinner-border text-light" role="status"></div><p class="mt-2 mb-0">Loading Evolution Data...</p>`; // Reset content
                }

                const [evolutionResponse, iceSheetResponse] = await Promise.all([
                    fetch('https://cheatsheets.davidveksler.com/evolution_data.json'),
                    fetch('https://cheatsheets.davidveksler.com/iceSheetGeoJson.json')
                ]);

                if (!evolutionResponse.ok) {
                    throw new Error(`HTTP error! status: ${evolutionResponse.status} for evolution data`);
                }
                if (!iceSheetResponse.ok) {
                    throw new Error(`HTTP error! status: ${iceSheetResponse.status} for ice sheet data`);
                }

                timePeriodsData = await evolutionResponse.json();
                fetchedIceSheetGeoJson = await iceSheetResponse.json(); // Assign to the new global variable

                if (!Array.isArray(timePeriodsData) || timePeriodsData.length === 0) {
                    throw new Error("Fetched evolution data is not a valid array or is empty.");
                }
                if (typeof fetchedIceSheetGeoJson !== 'object' || fetchedIceSheetGeoJson === null) { // Basic check for object
                    throw new Error("Fetched ice sheet data is not a valid object.");
                }

                initializeApplication();
            } catch (error) {
                console.error("Could not fetch initial data:", error);
                if (domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.innerHTML = "<strong class='text-danger'>Error loading data.</strong>";
                if (domElements.loadingScreen) {
                     domElements.loadingScreen.style.display = 'flex'; // Keep it visible for the error
                     domElements.loadingScreen.innerHTML = `<div class='p-3 text-center'><i class='bi bi-exclamation-triangle-fill text-danger h1'></i><p>Failed to load required data.<br><small>${error.message}</small></p></div>`;
                }
                 // Optionally, try to show controls sidebar even if data load fails, so user isn't stuck on loading screen
                if (domElements.controlsContentDiv && domElements.loadingScreen && domElements.loadingScreen.style.display === 'none') {
                    // If loading screen was already hidden by initializeApplication attempt that failed later.
                } else if (domElements.controlsContentDiv) {
                    // If loading screen is still up, hide it to show the error on a partially loaded page
                    // This might be tricky if initializeApplication depends heavily on the data.
                    // For now, the error is shown IN the loading screen.
                }
            }
        }
    
    
        function initializeApplication() {
            if (!domElements.loadingScreen || !domElements.controlsContentDiv) {
                console.error("Core UI elements (loadingScreen or controlsContentDiv) not found. Cannot initialize application properly.");
                document.body.innerHTML = `<div class='p-5 text-center text-danger'><h1>Application Error</h1><p>Essential UI components are missing. Please check the HTML structure and element IDs.</p></div>`;
                return;
            }

            domElements.loadingScreen.style.display = 'none';
            domElements.controlsContentDiv.classList.remove('d-none');

            Object.values(domElements).forEach(el => {
                if (el && typeof el.disabled === 'boolean') {
                    el.disabled = false;
                }
            });
            if (domElements.timelineScrubber) {
                domElements.timelineScrubber.max = timePeriodsData.length - 1;
            }

            populateAllSpeciesList();
            populateSpeciesFilter();
            currentPeriodIndex = 0;
            updateUIForCurrentPeriod();
            updateSpeedButtonsActiveState();

            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    
        function populateAllSpeciesList() {
            const speciesSet = new Map();
            timePeriodsData.forEach(period => {
                if (period.species && Array.isArray(period.species)) {
                    period.species.forEach(s => {
                        if (s && s.name && !speciesSet.has(s.name)) { 
                            speciesSet.set(s.name, { color: s.color || '#cccccc' }); 
                        }
                    });
                }
            });
            allSpeciesList = Array.from(speciesSet, ([name, data]) => ({ name, ...data }));
            allSpeciesList.sort((a, b) => a.name.localeCompare(b.name));
        }
    
        function populateSpeciesFilter() {
            domElements.speciesFilterList.innerHTML = '';
            if (allSpeciesList.length === 0) {
                domElements.speciesFilterList.innerHTML = '<p class="text-muted p-2 small">No species found in data.</p>'; return;
            }
            allSpeciesList.forEach(s => {
                selectedSpecies[s.name] = true; 
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-check';
                const input = document.createElement('input');
                input.type = 'checkbox'; input.className = 'form-check-input';
                input.id = `filter-${s.name.replace(/\W/g, '_')}`; input.value = s.name; input.checked = true;
                input.addEventListener('change', (event) => {
                    selectedSpecies[event.target.value] = event.target.checked;
                    updateUIForCurrentPeriod(); 
                });
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'species-color-indicator';
                colorIndicator.style.backgroundColor = s.color;
    
                const label = document.createElement('label');
                label.className = 'form-check-label'; label.htmlFor = input.id;
                label.style.color = 'var(--text-color)'; 
                label.textContent = s.name;
    
                itemDiv.appendChild(input);
                itemDiv.appendChild(colorIndicator);
                itemDiv.appendChild(label);
                domElements.speciesFilterList.appendChild(itemDiv);
            });
        }
    
        function updateUIForCurrentPeriod() {
            speciesGeoJsonLayerGroup.clearLayers(); 
    
            if (!timePeriodsData || timePeriodsData.length === 0 || currentPeriodIndex < 0 || currentPeriodIndex >= timePeriodsData.length) {
                if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = `Timeline End`;
                if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = "(Drag scrubber or Reset)";
                if(domElements.narrativeTextElement) {
                    domElements.narrativeTextElement.style.color = 'var(--text-color)'; // Ensure color
                    domElements.narrativeTextElement.textContent = "End of timeline data.";
                }
                if(domElements.legendItemsContainer) domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No active period.</small>';
                return;
            }
    
            const period = timePeriodsData[currentPeriodIndex];
            if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = period.periodName || "Unknown Period";
            if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = period.timeRange || `Period ${currentPeriodIndex + 1}`;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = currentPeriodIndex;
            
            if(domElements.narrativeTextElement) {
                domElements.narrativeTextElement.style.color = 'var(--text-color)'; // Ensure color
                domElements.narrativeTextElement.innerHTML = period.narrative || "No narrative available for this period.";
            }
    
            let speciesInCurrentPeriod = period.species || [];
            let visibleSpeciesInLegend = [];
    
            speciesInCurrentPeriod.forEach(s => {
                if (s && s.name && selectedSpecies[s.name]) {
                    visibleSpeciesInLegend.push(s); 
    
                    let popupContent = `<h5>${s.name}</h5>
                                        <p class="mb-1 small"><strong>Timeline:</strong> ${s.timeline || 'N/A'}</p>
                                        <p class="mb-0 small">${s.notes || 'No specific notes.'}</p>`;
    
                    if (s.estimatedRangeGeoJson && Object.keys(s.estimatedRangeGeoJson).length > 0) {
                        try {
                            L.geoJSON(s.estimatedRangeGeoJson, {
                                style: { fillColor: s.color || '#888888', weight: 1, opacity: 1, color: '#ccc', fillOpacity: 0.4 }
                            }).bindPopup(popupContent).addTo(speciesGeoJsonLayerGroup);
                        } catch (e) { console.warn("Error drawing range for", s.name, e); }
                    }
    
                    if (s.migrationPaths && Array.isArray(s.migrationPaths)) {
                        s.migrationPaths.forEach(path => {
                            if (path && Object.keys(path).length > 0) {
                               try {
                                    L.geoJSON(path, {
                                        style: { color: s.migrationColor || s.color || '#888888', weight: 2.5, opacity: 0.65, dashArray: '5, 5' }
                                    }).bindPopup(popupContent).addTo(speciesGeoJsonLayerGroup);
                                } catch (e) { console.warn("Error drawing migration for", s.name, e); }
                            }
                        });
                    }
                }
            });
            updateLegend(visibleSpeciesInLegend);
            updateClimateOverlay(period.timeRange);
        }
    
        function updateLegend(visibleSpecies) {
            if (!domElements.legendItemsContainer) return;
            domElements.legendItemsContainer.innerHTML = '';
            if (visibleSpecies.length === 0) {
                domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No species selected or in period.</small>'; return;
            }
            visibleSpecies.sort((a,b) => a.name.localeCompare(b.name));
            visibleSpecies.forEach(s => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'legend-item';
                const colorBox = document.createElement('span');
                colorBox.className = 'legend-color-box'; colorBox.style.backgroundColor = s.color || '#cccccc';
                const nameSpan = document.createElement('span'); nameSpan.textContent = s.name;
                nameSpan.style.color = 'var(--text-color)';
                itemDiv.appendChild(colorBox); itemDiv.appendChild(nameSpan);
                domElements.legendItemsContainer.appendChild(itemDiv);
            });
        }
    
        function parseYearFromRange(rangeString) {
            if (!rangeString) return { start: null, end: null };
            const cleaned = rangeString.toLowerCase().replace(/c\.|ago|years|million|kya|mya/g, '').trim();
            const parts = cleaned.split(/\s*-\s*|\s+to\s+/);
    
            function parsePart(part) {
                part = part.trim();
                let num = parseFloat(part.replace(/,/g, '')); 
                if (rangeString.toLowerCase().includes("million") || rangeString.toLowerCase().includes("mya")) {
                    num *= 1000000;
                } else if (rangeString.toLowerCase().includes("kya")) {
                    num *= 1000;
                }
                return isNaN(num) ? null : -Math.abs(num); 
            }
    
            let startYear = parsePart(parts[0]);
            let endYear = parts.length > 1 ? parsePart(parts[1]) : startYear;
    
            if (startYear && endYear === null) endYear = startYear;
            if (endYear && startYear === null) startYear = endYear;
    
            if (startYear && endYear && startYear > endYear) {
                [startYear, endYear] = [endYear, startYear];
            }
            return { start: startYear, end: endYear };
        }
    
        function updateClimateOverlay(periodTimeRange) {
            iceSheetLayerGroup.clearLayers();
            // MODIFICATION: Check if fetchedIceSheetGeoJson is loaded
            if (domElements.climateToggle && domElements.climateToggle.checked && periodTimeRange && fetchedIceSheetGeoJson) {
                const { start, end } = parseYearFromRange(periodTimeRange);
                const lgmStart = -26500; 
                const lgmEnd = -19000;  
    
                if (start && end && Math.max(start, lgmStart) <= Math.min(end, lgmEnd)) {
                    // MODIFICATION: Use fetchedIceSheetGeoJson
                    Object.values(fetchedIceSheetGeoJson).forEach(sheet => {
                        if (sheet && sheet.type && sheet.coordinates) { // Basic GeoJSON structure check
                           try {
                                L.geoJSON(sheet, {
                                    style: { color: '#ADC8E6', fillColor: '#ADD8E6', fillOpacity: 0.3, weight: 1 }
                                }).addTo(iceSheetLayerGroup);
                            } catch (e) {
                                console.warn("Error drawing ice sheet GeoJSON feature:", e, sheet);
                            }
                        } else {
                            console.warn("Invalid GeoJSON feature structure in ice sheet data:", sheet);
                        }
                    });
                }
            }
            if (domElements.climateToggle) { // Ensure domElements.climateToggle is not null
                if (!map.hasLayer(iceSheetLayerGroup) && domElements.climateToggle.checked && iceSheetLayerGroup.getLayers().length > 0) {
                    map.addLayer(iceSheetLayerGroup);
                } else if (map.hasLayer(iceSheetLayerGroup) && (!domElements.climateToggle.checked || iceSheetLayerGroup.getLayers().length === 0)) {
                    map.removeLayer(iceSheetLayerGroup);
                }
            }
        }
    
        // --- Animation & Controls ---
        function animationLoop(timestamp) {
            if (!isPlaying) return;
    
            if (timestamp - lastFrameTime >= (baseAnimationInterval / playbackSpeed)) {
                lastFrameTime = timestamp;
                currentPeriodIndex++;
                if (currentPeriodIndex >= timePeriodsData.length) {
                    currentPeriodIndex = timePeriodsData.length - 1; 
                    pauseAnimation();
                }
                updateUIForCurrentPeriod();
            }
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function playAnimation() {
            if (!timePeriodsData || timePeriodsData.length === 0) return;
            isPlaying = true;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-pause-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Pause";
            lastFrameTime = performance.now();
            if (currentPeriodIndex >= timePeriodsData.length - 1 && timePeriodsData.length > 0) {
                currentPeriodIndex = 0;
            }
            updateUIForCurrentPeriod(); 
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function pauseAnimation() {
            isPlaying = false;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-play-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Play";
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
    
        function togglePlayPause() {
            if (isPlaying) {
                pauseAnimation();
            } else {
                playAnimation();
            }
        }
    
        function resetAnimation() {
            pauseAnimation();
            currentPeriodIndex = 0;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = 0;
            playbackSpeed = 1;
            updateSpeedButtonsActiveState();
            if (allSpeciesList && allSpeciesList.length > 0) {
                 Object.keys(selectedSpecies).forEach(sName => {
                    selectedSpecies[sName] = true;
                });
                 document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            }
            updateUIForCurrentPeriod();
        }
    
        function updateSpeedButtonsActiveState() {
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-light');
                if (parseInt(btn.dataset.speed) === playbackSpeed) {
                    btn.classList.add('active', 'btn-primary');
                    btn.classList.remove('btn-outline-light');
                }
            });
        }
    
        // --- Event Listeners ---
        function addEventListeners() {
            if (!domElements.timelineScrubber || !domElements.playPauseButton || !domElements.resetButton) { 
                console.error("Cannot add event listeners: Core DOM elements for controls not found.");
                return;
            }
            domElements.timelineScrubber.addEventListener('input', (event) => {
                currentPeriodIndex = parseInt(event.target.value);
                pauseAnimation();
                updateUIForCurrentPeriod();
            });
            domElements.playPauseButton.addEventListener('click', togglePlayPause);
            domElements.resetButton.addEventListener('click', resetAnimation);
    
            document.querySelectorAll('.speed-btn').forEach(button => {
                button.addEventListener('click', () => {
                    playbackSpeed = parseInt(button.dataset.speed);
                    updateSpeedButtonsActiveState();
                });
            });
            const filterAllBtn = document.getElementById('filter-all');
            if(filterAllBtn) filterAllBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => selectedSpecies[s.name] = true);
                document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateUIForCurrentPeriod();
            });
            const filterNoneBtn = document.getElementById('filter-none');
            if(filterNoneBtn) filterNoneBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => selectedSpecies[s.name] = false);
                document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateUIForCurrentPeriod();
            });
            const filterHomoBtn = document.getElementById('filter-homo');
            if(filterHomoBtn) filterHomoBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => {
                    const isHomo = s.name.toLowerCase().includes('homo');
                    selectedSpecies[s.name] = isHomo;
                    const cb = document.getElementById(`filter-${s.name.replace(/\W/g, '_')}`);
                    if(cb) cb.checked = isHomo;
                });
                updateUIForCurrentPeriod();
            });

            if(domElements.climateToggle) { 
                domElements.climateToggle.addEventListener('change', () => {
                    if (timePeriodsData.length > 0 && fetchedIceSheetGeoJson) { // Ensure data is loaded
                         updateUIForCurrentPeriod(); 
                    }
                });
            }
        }
    
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDomElements(); 
            addEventListeners();   
            fetchAllRequiredData(); // MODIFICATION: Call new fetch function
        });
        </script>

  </body>
</html>