<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Human Evolution: Journey Through Time</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      :root {
        /* Evolved Color Palette */
        --primary-accent-start: #00AFFF;
        --primary-accent-end: #0078D4;
        --primary-accent-gradient: linear-gradient(135deg, var(--primary-accent-start), var(--primary-accent-end));
        --primary-accent-static: #0095E0;

        --danger-accent: #FF4757;
        --danger-accent-rgb: 255,71,87; /* For rgba glow */
        --warning-accent: #FFA500;
        --warning-accent-rgb: 255,165,0; /* For rgba background tint */

        --dark-bg: #0F1014;
        --dark-bg-rgb: 15,16,20;
        --medium-bg: #1A1C23;
        --medium-bg-rgb: 26,28,35;
        --light-bg: #2C2F3B;
        --lighter-bg: #3D414F;

        --text-color: #E0E0E5;
        --text-muted-color: #90909A;
        --text-heading-color: #FFFFFF;

        --timeline-period-color: #FFC107;

        /* Typography */
        --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-weight-light: 300;
        --font-weight-regular: 400;
        --font-weight-medium: 500;
        --font-weight-bold: 600;

        /* UI Dimensions & Effects */
        --sidebar-width: 380px;
        --header-height: 65px;
        --border-radius-standard: 10px;
        --border-radius-pill: 50px;
        --transition-speed: 0.25s;
        --transition-timing: ease-out;
        --modern-shadow: 0 8px 24px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.15);
        --card-element-shadow: 0 2px 8px rgba(0,0,0,0.2);
        --focus-ring-color: rgba(0, 160, 255, 0.7); /* Primary accent with alpha */
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-primary);
        margin: 0;
        overflow: hidden;
        background: var(--dark-bg);
        /* Optional subtle noise texture for richness:
           background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cfilter id='n' x='0' y='0'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
        */
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100vh;
        letter-spacing: 0.01em;
      }

      header.app-header {
        height: var(--header-height);
        background: var(--dark-bg);
        border-bottom: 2px solid var(--primary-accent-static);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        flex-shrink: 0;
      }

      header.app-header h1 {
        font-size: 1.5rem;
        font-weight: var(--font-weight-light);
        margin: 0;
        letter-spacing: 0.5px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        color: var(--text-heading-color);
      }
      header.app-header h1 i {
        color: var(--primary-accent-static);
        margin-right: 0.75rem;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }


      #main-content {
        display: flex;
        height: calc(100vh - var(--header-height));
        flex-grow: 1;
      }

      #controls-sidebar {
        width: var(--sidebar-width);
        background: var(--medium-bg);
        border-right: 1px solid var(--light-bg);
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      @media (max-width: 992px) {
        #main-content {
          flex-direction: column;
        }
        #controls-sidebar {
          width: 100%;
          max-height: 45vh;
          border-right: none;
          border-bottom: 1px solid var(--light-bg);
        }
        #map-container {
          flex-grow: 1;
          height: auto;
        }
      }

      #map-container {
        flex: 1;
        position: relative;
        background: #0a0a0a; /* Original, could be var(--dark-bg) too */
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .control-card {
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard);
        box-shadow: var(--modern-shadow);
        transition: transform var(--transition-speed) var(--transition-timing), box-shadow var(--transition-speed) var(--transition-timing);
      }
      .control-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 28px rgba(0,0,0,0.35), 0 2px 5px rgba(0,0,0,0.2), 0 0 0 1px var(--lighter-bg);
      }

      .control-card .card-header {
        font-size: 0.9rem;
        font-weight: var(--font-weight-medium);
        background-color: transparent;
        color: var(--text-muted-color);
        border-bottom: 1px solid var(--light-bg);
        padding: 0.6rem 1rem;
        display: flex;
        align-items: center;
        letter-spacing: 0.03em;
        text-transform: uppercase;
      }
      .control-card .card-header i {
        margin-right: 0.4rem;
        font-size: 0.9em;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }

      .control-card .card-body {
        padding: 0.8rem 1rem;
      }
      .control-card .card-header + .card-body {
        padding-top: 1rem;
      }

      p, .form-check-label, .legend-item span {
        line-height: 1.65;
        font-size: 0.85rem;
      }
      /* Specific narrative text element to ensure it takes base body styling */
      #narrative-panel .card-body p#narrative-text-element {
          line-height: 1.65;
          font-size: 0.85rem;
          color: var(--text-color) !important;
      }


      #current-period-display {
        font-size: 1.25rem;
        font-weight: var(--font-weight-bold);
        margin-top: 0.1rem;
        margin-bottom: 0.25rem;
        text-align: center;
        color: var(--timeline-period-color);
      }

      #timeline-value-display {
        font-weight: var(--font-weight-regular);
        font-size: 0.8rem;
        color: var(--text-muted-color);
        display: block;
        text-align: center;
        margin-bottom: 0.75rem;
      }

      #timeline-scrubber {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: var(--light-bg);
        outline: none;
        margin: 0.75rem 0;
        transition: background-color var(--transition-speed) var(--transition-timing);
      }
      #timeline-scrubber::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-accent-static);
        border: 2px solid var(--dark-bg);
        cursor: pointer;
        box-shadow: 0 0 8px var(--focus-ring-color);
        transition: transform 0.1s ease-out, background-color var(--transition-speed) var(--transition-timing);
      }
      #timeline-scrubber::-webkit-slider-thumb:hover {
        transform: scale(1.15);
      }
      #timeline-scrubber::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-accent-static);
        cursor: pointer;
        border: 2px solid var(--dark-bg);
        box-shadow: 0 0 8px var(--focus-ring-color);
        transition: transform 0.1s ease-out, background-color var(--transition-speed) var(--transition-timing);
      }
      #timeline-scrubber::-moz-range-thumb:hover {
        transform: scale(1.15);
      }

      .timeline-buttons .btn,
      .quick-filter-buttons .btn {
        border-radius: var(--border-radius-pill);
        padding: 0.35rem 0.85rem;
        font-size: 0.8rem;
        font-weight: var(--font-weight-medium);
        transition: background var(--transition-speed) var(--transition-timing),
                    color var(--transition-speed) var(--transition-timing),
                    border-color var(--transition-speed) var(--transition-timing),
                    filter var(--transition-speed) var(--transition-timing),
                    box-shadow var(--transition-speed) var(--transition-timing);
        border: 1px solid var(--light-bg);
        margin-top: 0.25rem; /* Retain original */
      }
      .timeline-buttons .btn i,
      #reset-button i {
        margin-right: 0.35rem;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }
      .timeline-buttons .btn:hover i, /* Only scale icon if button itself is hovered */
      #reset-button:hover i {
          transform: scale(1.1);
      }
      .timeline-buttons .btn-group { margin-top: 0.25rem; } /* Retain original */


      /* Primary styled buttons (Play, active speed, active quick filters) */
      #play-pause-button,
      .timeline-buttons .speed-btn.active,
      .quick-filter-buttons .btn.active {
          background: var(--primary-accent-gradient);
          border-color: transparent;
          color: var(--text-heading-color);
          box-shadow: var(--card-element-shadow);
      }
      #play-pause-button:hover,
      .timeline-buttons .speed-btn.active:hover,
      .quick-filter-buttons .btn.active:hover {
          filter: brightness(110%);
          box-shadow: 0 4px 12px var(--focus-ring-color);
      }

      /* Outline styled buttons (inactive speed, inactive quick filters) */
      .btn-outline-light {
          color: var(--text-muted-color);
          border-color: var(--light-bg);
          background-color: transparent;
      }
      .btn-outline-light:hover,
      .btn-outline-light.active { /* .active might be added by bootstrap too */
          color: var(--text-heading-color); /* Text color for active/hover state */
          background-color: var(--primary-accent-static); /* Use static accent for hover of outline */
          border-color: var(--primary-accent-static);
      }
       /* Ensure active quick filter buttons specifically use the gradient */
      .quick-filter-buttons .btn.active,
      .timeline-buttons .speed-btn.active {
          background: var(--primary-accent-gradient); /* Override general .active if needed */
          border-color: transparent;
          color: var(--text-heading-color);
      }
      .quick-filter-buttons .btn.active:hover,
      .timeline-buttons .speed-btn.active:hover {
        filter: brightness(110%);
        box-shadow: 0 4px 12px var(--focus-ring-color);
      }


      #reset-button {
          background-color: var(--danger-accent);
          border-color: var(--danger-accent);
          color: white;
          box-shadow: var(--card-element-shadow);
      }
      #reset-button:hover {
          filter: brightness(110%);
          box-shadow: 0 4px 12px rgba(var(--danger-accent-rgb), 0.5);
      }

      #species-filter-list {
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard);
        padding: 0.5rem;
        margin-top: 0.5rem;
        background-color: var(--dark-bg);
      }
      #species-filter-list .form-check {
        padding: 0.4rem 0.6rem;
        border-bottom: 1px solid var(--light-bg);
        display: flex;
        align-items: center;
        transition: background-color var(--transition-speed) var(--transition-timing);
        border-radius: 4px;
      }
      #species-filter-list .form-check:hover {
        background-color: var(--lighter-bg);
      }
      #species-filter-list .form-check:last-child {
        border-bottom: none;
      }
      #species-filter-list .form-check-label {
        font-size: 0.8rem; /* Overridden by general p styling, but kept for specificity if needed */
        cursor: pointer;
        margin-left: 0.5rem;
        color: var(--text-color);
      }

      #species-filter-list .form-check-input {
        appearance: none;
        -webkit-appearance: none;
        background-color: var(--medium-bg);
        border: 1px solid var(--light-bg);
        border-radius: 4px;
        width: 1.1em;
        height: 1.1em;
        position: relative;
        cursor: pointer;
        transition: background var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing);
        margin-top: 0.15em;
        flex-shrink: 0;
      }
      #species-filter-list .form-check-input:checked {
        background: var(--primary-accent-gradient);
        border-color: transparent;
      }
      #species-filter-list .form-check-input:checked::before {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8em;
        color: white;
        font-weight: bold;
      }

      .species-color-indicator {
        width: 12px;
        height: 12px;
        display: inline-block;
        margin-left: 0.5rem;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      #narrative-panel .card-body {
        /* font-size: 0.8rem; Original, now handled by p#narrative-text-element */
        /* line-height: 1.5; Original */
        color: var(--text-color);
        overflow-y: auto;
      }
      #narrative-panel .card-body strong {
        color: var(--timeline-period-color);
        font-weight: var(--font-weight-medium);
      }
       #narrative-text-element { /* Ensured by specific p rule above */
        color: var(--text-color) !important;
      }

      .data-limitation-note {
        color: var(--warning-accent);
        font-size: 0.78rem;
        border-top: 1px dashed var(--light-bg); /* Original had this, now it's a bg box */
        padding-top: 0.6rem;
        margin-top: 0.75rem;
        background-color: rgba(var(--warning-accent-rgb), 0.05);
        padding: 0.5rem;
        border-radius: 4px;
      }
      .data-limitation-note i {
        margin-right: 0.35rem;
        color: var(--warning-accent);
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }

      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 0.75rem 1rem;
        background: rgba(var(--medium-bg-rgb), 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: var(--modern-shadow);
        border-radius: var(--border-radius-standard);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--light-bg);
        color: var(--text-color);
      }
      .legend h5 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: var(--font-weight-medium);
        color: var(--text-heading-color);
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 0.4rem;
      }
      .legend h5 i {
        font-size: 0.85em;
        margin-right: 0.25rem;
        transition: transform var(--transition-speed) var(--transition-timing);
        vertical-align: middle;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.3rem;
        /* font-size: 0.78rem; Handled by general p/span rule */
        padding: 0.1rem 0;
      }
      .legend-color-box {
        width: 12px;
        height: 12px;
        margin-right: 5px;
        border: none;
        opacity: 1;
        flex-shrink: 0;
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
      }

      .loading-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(var(--dark-bg-rgb), 0.95);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        /* color: white; Handled by p */
        /* font-size: 1.2rem; Handled by p */
        z-index: 9999;
        flex-direction: column;
      }
      .loading-overlay .spinner-border {
        display: none;
      }
      .loading-overlay::before {
        content: "";
        display: block;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 4px solid var(--light-bg);
        border-top-color: var(--primary-accent-static);
        animation: customSpinner 0.8s linear infinite;
        margin-bottom: 1.5rem;
      }
      @keyframes customSpinner { to { transform: rotate(360deg); } }
      .loading-overlay p {
        margin-top: 0;
        margin-bottom: 0;
        font-size: 1.1rem;
        font-weight: var(--font-weight-light);
        letter-spacing: 0.05em;
        color: var(--text-color);
      }

      .climate-toggle-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--medium-bg);
        padding: 0.4rem 0.6rem;
        border-radius: var(--border-radius-standard); /* Updated radius */
        z-index: 1000;
        box-shadow: var(--modern-shadow); /* Updated shadow */
        border: 1px solid var(--light-bg);
      }
      .climate-toggle-container .form-check-label {
        font-size: 0.75rem; /* Original */
        color: var(--text-muted-color);
      }
      .climate-toggle-container .form-check-input {
        border-color: var(--primary-accent-static); /* Use static for consistency */
        background-color: var(--medium-bg); /* Ensure it's not transparent */
      }
      .climate-toggle-container .form-check-input:checked {
        background-color: var(--primary-accent-static);
        border-color: var(--primary-accent-static);
      }


      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        background-color: var(--medium-bg) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--light-bg) !important;
        border-radius: var(--border-radius-standard) !important; /* Softer radius */
        box-shadow: var(--card-element-shadow) !important; /* Subtle shadow */
        transition: background-color var(--transition-speed) var(--transition-timing) !important;
      }
      .leaflet-control-zoom-in:hover,
      .leaflet-control-zoom-out:hover {
        background-color: var(--light-bg) !important;
      }

      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: var(--medium-bg);
        color: var(--text-color);
        box-shadow: var(--modern-shadow);
        border: 1px solid var(--light-bg);
        border-radius: var(--border-radius-standard);
      }
      .leaflet-popup-content-wrapper { padding: 1px; } /* Leaflet default behavior */
      .leaflet-popup-content { /* Inner content area */
        padding: 0.8rem 1rem;
        font-size: 0.85rem;
        line-height: 1.6;
        margin: 0 !important; /* Override Leaflet's p margin */
      }
      .leaflet-popup-content h5 {
        margin-top: 0;
        margin-bottom: 0.6rem;
        font-size: 1.1em;
        font-weight: var(--font-weight-medium);
        color: var(--primary-accent-static);
        border-bottom: 1px solid var(--light-bg);
        padding-bottom: 0.4rem;
      }
      .leaflet-container a.leaflet-popup-close-button {
        color: var(--text-muted-color);
        padding: 8px 8px 0 0;
        transition: color var(--transition-speed) var(--transition-timing);
      }
      .leaflet-container a.leaflet-popup-close-button:hover {
        color: var(--danger-accent);
      }

      /* Focus States */
      *:focus-visible {
        outline: 2px solid var(--focus-ring-color);
        outline-offset: 2px;
        /* box-shadow: 0 0 0 3px rgba(var(--focus-ring-color-rgb), 0.5); Requires focus-ring-color-rgb */
      }
      #species-filter-list .form-check-input:focus-visible {
        box-shadow: 0 0 0 2px var(--dark-bg), 0 0 0 4px var(--focus-ring-color);
      }
       /* Ensure tooltips are styled for the new theme if they appear */
      .tooltip-inner {
        background-color: var(--primary-accent-static);
        color: var(--text-heading-color);
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
      .tooltip .tooltip-arrow::before {
        border-top-color: var(--primary-accent-static) !important; /* Example for top tooltip */
        border-bottom-color: var(--primary-accent-static) !important; /* Example for bottom tooltip */
        border-left-color: var(--primary-accent-static) !important;
        border-right-color: var(--primary-accent-static) !important;
      }

    </style>
  </head>

  <body>
    <div id="loading-screen" class="loading-overlay">
      <!-- Spinner is now CSS-only via ::before on loading-overlay -->
      <p class="mt-2 mb-0">Loading Evolution Data...</p>
    </div>
    <header class="app-header">
      <h1><i class="bi bi-globe-americas"></i> Human Evolution: Journey Through Time</h1>
    </header>
    <div id="main-content">
      <aside id="controls-sidebar">
        <div id="controls-content" class="d-none h-100 d-flex flex-column">
          <div class="control-card card">
            <div class="card-header"><i class="bi bi-clock-history"></i> Timeline Control</div>
            <div class="card-body">
              <div id="current-period-display">Data not loaded.</div>
              <span id="timeline-value-display"></span>
              <input
                type="range"
                class="form-range" /* Bootstrap class, custom styles will override */
                id="timeline-scrubber"
                min="0"
                value="0"
                disabled
                data-bs-toggle="tooltip"
                title="Drag to select a time period"
              />
              <div class="d-flex justify-content-between align-items-center mt-2 timeline-buttons">
                <button
                  id="play-pause-button"
                  class="btn btn-sm" /* Removed btn-primary, style handled by ID */
                  disabled
                  data-bs-toggle="tooltip"
                  title="Play or Pause animation"
                >
                  <i class="bi bi-play-fill"></i> <span>Play</span>
                </button>
                <div
                  class="btn-group btn-group-sm"
                  role="group"
                  data-bs-toggle="tooltip"
                  title="Adjust animation speed"
                >
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="1">1x</button>
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="2">2x</button>
                  <button type="button" class="btn btn-outline-light speed-btn" data-speed="5">5x</button>
                </div>
                <button
                  id="reset-button"
                  class="btn btn-sm" /* Removed btn-danger, style handled by ID */
                  disabled
                  data-bs-toggle="tooltip"
                  title="Reset timeline to start"
                >
                  <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
              </div>
            </div>
          </div>
          <div class="control-card card">
            <div class="card-header"><i class="bi bi-people-fill"></i> Species Filter</div>
            <div class="card-body">
              <div class="btn-group btn-group-sm mb-2 quick-filter-buttons" role="group">
                <button class="btn btn-outline-light" id="filter-all" data-bs-toggle="tooltip" title="Show all species">
                  All
                </button>
                <button
                  class="btn btn-outline-light"
                  id="filter-none"
                  data-bs-toggle="tooltip"
                  title="Hide all species"
                >
                  None
                </button>
                <button
                  class="btn btn-outline-light"
                  id="filter-homo"
                  data-bs-toggle="tooltip"
                  title="Show only Homo genus"
                >
                  Homo
                </button>
              </div>
              <div id="species-filter-list">
                <p class="text-muted p-2 small">No species data loaded.</p>
              </div>
            </div>
          </div>
          <div id="narrative-panel" class="control-card card flex-grow-1 mb-0">
            <div class="card-header"><i class="bi bi-book-half"></i> Period Overview</div>
            <div class="card-body">
              <p id="narrative-text-element">Select a time period to see an overview.</p>
              <p class="data-limitation-note">
                <i class="bi bi-exclamation-triangle-fill"></i> Note: Geographic map display depends on data in the
                fetched dataset. Active species are listed in the legend.
              </p>
            </div>
          </div>
        </div>
      </aside>
      <main id="map-container">
        <div id="map"></div>
        <div class="climate-toggle-container">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="climate-toggle-switch"
              data-bs-toggle="tooltip"
              title="Toggle Last Glacial Maximum ice sheets"
            />
            <label class="form-check-label" for="climate-toggle-switch">Ice Sheets</label>
          </div>
        </div>
        <div id="legend" class="legend">
          <h5><i class="bi bi-palette"></i> Legend</h5>
          <div id="legend-items-container"><small class="text-muted">Data not loaded.</small></div>
        </div>
      </main>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   
    <script>
        // --- State & Config ---
        let timePeriodsData = [];
        let fetchedIceSheetGeoJson = null;
        const map = L.map('map', { worldCopyJump: true, zoomControl: false }).setView([20, 40], 2);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd', maxZoom: 19
        }).addTo(map);
    
        let iceSheetLayerGroup = L.layerGroup();
        let speciesGeoJsonLayerGroup = L.layerGroup().addTo(map);
    
        let currentPeriodIndex = 0;
        let selectedSpecies = {};
        let allSpeciesList = [];
        let isPlaying = false;
        let animationFrameId;
        let lastFrameTime = 0;
        let playbackSpeed = 1; 
        const baseAnimationInterval = 3500; 
    
        const domElements = {
            timelineScrubber: null,
            currentPeriodDisplay: null,
            timelineValueDisplay: null,
            speciesFilterList: null,
            legendItemsContainer: null,
            playPauseButton: null,
            playPauseIcon: null, 
            playPauseText: null, 
            resetButton: null,
            narrativeTextElement: null,
            loadingScreen: null,
            controlsContentDiv: null,
            climateToggle: null
        };
    
        function populateDomElements() {
            const idMap = {
                controlsContentDiv: 'controls-content',
                climateToggle: 'climate-toggle-switch'
            };
            for (const key in domElements) {
                if (key === 'playPauseIcon' || key === 'playPauseText') continue;
                const elementId = idMap[key] || key.replace(/([A-Z])/g, '-$1').toLowerCase();
                domElements[key] = document.getElementById(elementId);
                if (!domElements[key]) {
                    console.warn(`DOM element with ID '${elementId}' (for key '${key}') not found.`);
                }
            }
            if (domElements.playPauseButton) {
                domElements.playPauseIcon = domElements.playPauseButton.querySelector('i');
                domElements.playPauseText = domElements.playPauseButton.querySelector('span');
                if (!domElements.playPauseIcon) console.warn("Play/Pause button icon (<i>) not found.");
                if (!domElements.playPauseText) console.warn("Play/Pause button text (<span>) not found.");
            } else {
                console.error("playPauseButton element not found, cannot derive icon and text elements.");
            }
        }
    
        async function fetchAllRequiredData() {
            try {
                if (domElements.loadingScreen) {
                     domElements.loadingScreen.style.display = 'flex'; 
                     domElements.loadingScreen.querySelector('p').textContent = 'Loading Evolution Data...';
                }

                const [evolutionResponse, iceSheetResponse] = await Promise.all([
                    fetch('https://cheatsheets.davidveksler.com/evolution_data.json'),
                    fetch('https://cheatsheets.davidveksler.com/iceSheetGeoJson.json')
                ]);

                if (!evolutionResponse.ok) {
                    throw new Error(`HTTP error! status: ${evolutionResponse.status} for evolution data`);
                }
                if (!iceSheetResponse.ok) {
                    throw new Error(`HTTP error! status: ${iceSheetResponse.status} for ice sheet data`);
                }

                timePeriodsData = await evolutionResponse.json();
                fetchedIceSheetGeoJson = await iceSheetResponse.json(); 

                if (!Array.isArray(timePeriodsData) || timePeriodsData.length === 0) {
                    throw new Error("Fetched evolution data is not a valid array or is empty.");
                }
                if (typeof fetchedIceSheetGeoJson !== 'object' || fetchedIceSheetGeoJson === null) {
                    throw new Error("Fetched ice sheet data is not a valid object.");
                }

                initializeApplication();
            } catch (error) {
                console.error("Could not fetch initial data:", error);
                if (domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.innerHTML = "<strong class='text-danger'>Error loading data.</strong>";
                if (domElements.loadingScreen) {
                     domElements.loadingScreen.style.display = 'flex'; 
                     domElements.loadingScreen.innerHTML = `<div class='p-3 text-center'><i class='bi bi-exclamation-triangle-fill text-danger h1'></i><p class="text-light">Failed to load required data.<br><small>${error.message}</small></p></div>`;
                }
            }
        }
    
    
        function initializeApplication() {
            if (!domElements.loadingScreen || !domElements.controlsContentDiv) {
                console.error("Core UI elements (loadingScreen or controlsContentDiv) not found. Cannot initialize application properly.");
                document.body.innerHTML = `<div class='p-5 text-center text-danger'><h1>Application Error</h1><p>Essential UI components are missing. Please check the HTML structure and element IDs.</p></div>`;
                return;
            }

            domElements.loadingScreen.style.display = 'none';
            domElements.controlsContentDiv.classList.remove('d-none');

            Object.values(domElements).forEach(el => {
                if (el && typeof el.disabled === 'boolean') {
                    el.disabled = false;
                }
            });
            if (domElements.timelineScrubber) {
                domElements.timelineScrubber.max = timePeriodsData.length - 1;
            }

            populateAllSpeciesList();
            populateSpeciesFilter();
            currentPeriodIndex = 0;
            updateSpeedButtonsActiveState(); // Includes ensuring 1x is active
            updateQuickFilterActiveState('filter-all'); // Set 'All' as active by default
            updateUIForCurrentPeriod();


            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    
        function populateAllSpeciesList() {
            const speciesSet = new Map();
            timePeriodsData.forEach(period => {
                if (period.species && Array.isArray(period.species)) {
                    period.species.forEach(s => {
                        if (s && s.name && !speciesSet.has(s.name)) { 
                            speciesSet.set(s.name, { color: s.color || '#cccccc' }); 
                        }
                    });
                }
            });
            allSpeciesList = Array.from(speciesSet, ([name, data]) => ({ name, ...data }));
            allSpeciesList.sort((a, b) => a.name.localeCompare(b.name));
        }
    
        function populateSpeciesFilter() {
            domElements.speciesFilterList.innerHTML = '';
            if (allSpeciesList.length === 0) {
                domElements.speciesFilterList.innerHTML = '<p class="text-muted p-2 small">No species found in data.</p>'; return;
            }
            allSpeciesList.forEach(s => {
                selectedSpecies[s.name] = true; 
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-check';
                const input = document.createElement('input');
                input.type = 'checkbox'; input.className = 'form-check-input';
                input.id = `filter-${s.name.replace(/\W/g, '_')}`; input.value = s.name; input.checked = true;
                input.addEventListener('change', (event) => {
                    selectedSpecies[event.target.value] = event.target.checked;
                    updateUIForCurrentPeriod(); 
                    updateQuickFilterActiveState(null); // Clear All/None/Homo if individual changes
                });
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'species-color-indicator';
                colorIndicator.style.backgroundColor = s.color;
    
                const label = document.createElement('label');
                label.className = 'form-check-label'; label.htmlFor = input.id;
                // label.style.color = 'var(--text-color)'; // Set by global CSS
                label.textContent = s.name;
    
                itemDiv.appendChild(input);
                itemDiv.appendChild(colorIndicator); // Swapped order with label for better alignment with custom checkbox
                itemDiv.appendChild(label);
                domElements.speciesFilterList.appendChild(itemDiv);
            });
        }
    
        function updateUIForCurrentPeriod() {
            speciesGeoJsonLayerGroup.clearLayers(); 
    
            if (!timePeriodsData || timePeriodsData.length === 0 || currentPeriodIndex < 0 || currentPeriodIndex >= timePeriodsData.length) {
                if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = `Timeline End`;
                if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = "(Drag scrubber or Reset)";
                if(domElements.narrativeTextElement) {
                    domElements.narrativeTextElement.style.color = 'var(--text-color)';
                    domElements.narrativeTextElement.textContent = "End of timeline data.";
                }
                if(domElements.legendItemsContainer) domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No active period.</small>';
                return;
            }
    
            const period = timePeriodsData[currentPeriodIndex];
            if(domElements.currentPeriodDisplay) domElements.currentPeriodDisplay.textContent = period.periodName || "Unknown Period";
            if(domElements.timelineValueDisplay) domElements.timelineValueDisplay.textContent = period.timeRange || `Period ${currentPeriodIndex + 1}`;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = currentPeriodIndex;
            
            if(domElements.narrativeTextElement) {
                domElements.narrativeTextElement.style.color = 'var(--text-color)';
                domElements.narrativeTextElement.innerHTML = period.narrative || "No narrative available for this period.";
            }
    
            let speciesInCurrentPeriod = period.species || [];
            let visibleSpeciesInLegend = [];
    
            speciesInCurrentPeriod.forEach(s => {
                if (s && s.name && selectedSpecies[s.name]) {
                    visibleSpeciesInLegend.push(s); 
    
                    let popupContent = `<h5>${s.name}</h5>
                                        <p class="mb-1 small"><strong>Timeline:</strong> ${s.timeline || 'N/A'}</p>
                                        <p class="mb-0 small">${s.notes || 'No specific notes.'}</p>`;
    
                    if (s.estimatedRangeGeoJson && Object.keys(s.estimatedRangeGeoJson).length > 0) {
                        try {
                            L.geoJSON(s.estimatedRangeGeoJson, {
                                style: { // AWESOME EDITION STYLE
                                    fillColor: s.color || '#888888',
                                    weight: 1.5, 
                                    opacity: 1,
                                    color: 'rgba(255,255,255,0.3)', 
                                    fillOpacity: 0.55,
                                }
                            }).bindPopup(popupContent).addTo(speciesGeoJsonLayerGroup);
                        } catch (e) { console.warn("Error drawing range for", s.name, e); }
                    }
    
                    if (s.migrationPaths && Array.isArray(s.migrationPaths)) {
                        s.migrationPaths.forEach(path => {
                            if (path && Object.keys(path).length > 0) {
                               try {
                                    L.geoJSON(path, {
                                        style: { // AWESOME EDITION STYLE
                                            color: s.migrationColor || s.color || '#888888',
                                            weight: 3, 
                                            opacity: 0.75,
                                            dashArray: '8, 6', 
                                            lineCap: 'round' 
                                        }
                                    }).bindPopup(popupContent).addTo(speciesGeoJsonLayerGroup);
                                } catch (e) { console.warn("Error drawing migration for", s.name, e); }
                            }
                        });
                    }
                }
            });
            updateLegend(visibleSpeciesInLegend);
            updateClimateOverlay(period.timeRange);
        }
    
        function updateLegend(visibleSpecies) {
            if (!domElements.legendItemsContainer) return;
            domElements.legendItemsContainer.innerHTML = '';
            if (visibleSpecies.length === 0) {
                domElements.legendItemsContainer.innerHTML = '<small class="text-muted">No species selected or in period.</small>'; return;
            }
            visibleSpecies.sort((a,b) => a.name.localeCompare(b.name));
            visibleSpecies.forEach(s => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'legend-item';
                const colorBox = document.createElement('span');
                colorBox.className = 'legend-color-box'; colorBox.style.backgroundColor = s.color || '#cccccc';
                const nameSpan = document.createElement('span'); nameSpan.textContent = s.name;
                // nameSpan.style.color = 'var(--text-color)'; // Set by global CSS
                itemDiv.appendChild(colorBox); itemDiv.appendChild(nameSpan);
                domElements.legendItemsContainer.appendChild(itemDiv);
            });
        }
    
        function parseYearFromRange(rangeString) {
            if (!rangeString) return { start: null, end: null };
            const cleaned = rangeString.toLowerCase().replace(/c\.|ago|years|million|kya|mya/g, '').trim();
            const parts = cleaned.split(/\s*-\s*|\s+to\s+/);
    
            function parsePart(part) {
                part = part.trim();
                let num = parseFloat(part.replace(/,/g, '')); 
                if (rangeString.toLowerCase().includes("million") || rangeString.toLowerCase().includes("mya")) {
                    num *= 1000000;
                } else if (rangeString.toLowerCase().includes("kya")) {
                    num *= 1000;
                }
                return isNaN(num) ? null : -Math.abs(num); 
            }
    
            let startYear = parsePart(parts[0]);
            let endYear = parts.length > 1 ? parsePart(parts[1]) : startYear;
    
            if (startYear && endYear === null) endYear = startYear;
            if (endYear && startYear === null) startYear = endYear;
    
            if (startYear && endYear && startYear > endYear) {
                [startYear, endYear] = [endYear, startYear];
            }
            return { start: startYear, end: endYear };
        }
    
        function updateClimateOverlay(periodTimeRange) {
            iceSheetLayerGroup.clearLayers();
            if (domElements.climateToggle && domElements.climateToggle.checked && periodTimeRange && fetchedIceSheetGeoJson) {
                const { start, end } = parseYearFromRange(periodTimeRange);
                const lgmStart = -26500; 
                const lgmEnd = -19000;  
    
                if (start && end && Math.max(start, lgmStart) <= Math.min(end, lgmEnd)) {
                    Object.values(fetchedIceSheetGeoJson).forEach(sheet => {
                        if (sheet && sheet.type && sheet.coordinates) { 
                           try {
                                L.geoJSON(sheet, {
                                    style: { // AWESOME EDITION STYLE
                                        color: 'rgba(173, 216, 230, 0.5)', 
                                        fillColor: '#A2D1E6', 
                                        fillOpacity: 0.35,
                                        weight: 1
                                    }
                                }).addTo(iceSheetLayerGroup);
                            } catch (e) {
                                console.warn("Error drawing ice sheet GeoJSON feature:", e, sheet);
                            }
                        } else {
                            console.warn("Invalid GeoJSON feature structure in ice sheet data:", sheet);
                        }
                    });
                }
            }
            if (domElements.climateToggle) { 
                if (!map.hasLayer(iceSheetLayerGroup) && domElements.climateToggle.checked && iceSheetLayerGroup.getLayers().length > 0) {
                    map.addLayer(iceSheetLayerGroup);
                } else if (map.hasLayer(iceSheetLayerGroup) && (!domElements.climateToggle.checked || iceSheetLayerGroup.getLayers().length === 0)) {
                    map.removeLayer(iceSheetLayerGroup);
                }
            }
        }
    
        // --- Animation & Controls ---
        function animationLoop(timestamp) {
            if (!isPlaying) return;
    
            if (timestamp - lastFrameTime >= (baseAnimationInterval / playbackSpeed)) {
                lastFrameTime = timestamp;
                currentPeriodIndex++;
                if (currentPeriodIndex >= timePeriodsData.length) {
                    currentPeriodIndex = timePeriodsData.length - 1; 
                    pauseAnimation();
                }
                updateUIForCurrentPeriod();
            }
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function playAnimation() {
            if (!timePeriodsData || timePeriodsData.length === 0) return;
            isPlaying = true;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-pause-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Pause";
            lastFrameTime = performance.now();
            if (currentPeriodIndex >= timePeriodsData.length - 1 && timePeriodsData.length > 0) {
                currentPeriodIndex = 0;
            }
            updateUIForCurrentPeriod(); 
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    
        function pauseAnimation() {
            isPlaying = false;
            if (domElements.playPauseIcon) domElements.playPauseIcon.className = 'bi bi-play-fill';
            if (domElements.playPauseText) domElements.playPauseText.textContent = "Play";
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
    
        function togglePlayPause() {
            if (isPlaying) {
                pauseAnimation();
            } else {
                playAnimation();
            }
        }
    
        function resetAnimation() {
            pauseAnimation();
            currentPeriodIndex = 0;
            if (domElements.timelineScrubber) domElements.timelineScrubber.value = 0;
            playbackSpeed = 1;
            updateSpeedButtonsActiveState();
            if (allSpeciesList && allSpeciesList.length > 0) {
                 Object.keys(selectedSpecies).forEach(sName => {
                    selectedSpecies[sName] = true;
                });
                 document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            }
            updateQuickFilterActiveState('filter-all'); // Reset to 'All'
            updateUIForCurrentPeriod();
        }
    
        function updateSpeedButtonsActiveState() {
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('btn-outline-light'); // Ensure outline is re-applied
                if (parseInt(btn.dataset.speed) === playbackSpeed) {
                    btn.classList.add('active');
                    btn.classList.remove('btn-outline-light'); // Remove outline for active state
                }
            });
        }

        // Function to update active state for quick filter buttons
        function updateQuickFilterActiveState(activeButtonId) {
            document.querySelectorAll('.quick-filter-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('btn-outline-light'); // Ensure outline is re-applied
            });
            if (activeButtonId) {
                const activeButton = document.getElementById(activeButtonId);
                if (activeButton) {
                    activeButton.classList.add('active');
                    activeButton.classList.remove('btn-outline-light'); // Remove outline for active state
                }
            }
        }
    
        // --- Event Listeners ---
        function addEventListeners() {
            if (!domElements.timelineScrubber || !domElements.playPauseButton || !domElements.resetButton) { 
                console.error("Cannot add event listeners: Core DOM elements for controls not found.");
                return;
            }
            domElements.timelineScrubber.addEventListener('input', (event) => {
                currentPeriodIndex = parseInt(event.target.value);
                pauseAnimation();
                updateUIForCurrentPeriod();
            });
            domElements.playPauseButton.addEventListener('click', togglePlayPause);
            domElements.resetButton.addEventListener('click', resetAnimation);
    
            document.querySelectorAll('.speed-btn').forEach(button => {
                button.addEventListener('click', () => {
                    playbackSpeed = parseInt(button.dataset.speed);
                    updateSpeedButtonsActiveState();
                });
            });
            const filterAllBtn = document.getElementById('filter-all');
            if(filterAllBtn) filterAllBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => selectedSpecies[s.name] = true);
                document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateUIForCurrentPeriod();
                updateQuickFilterActiveState('filter-all');
            });
            const filterNoneBtn = document.getElementById('filter-none');
            if(filterNoneBtn) filterNoneBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => selectedSpecies[s.name] = false);
                document.querySelectorAll('#species-filter-list input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateUIForCurrentPeriod();
                updateQuickFilterActiveState('filter-none');
            });
            const filterHomoBtn = document.getElementById('filter-homo');
            if(filterHomoBtn) filterHomoBtn.addEventListener('click', () => {
                allSpeciesList.forEach(s => {
                    const isHomo = s.name.toLowerCase().includes('homo');
                    selectedSpecies[s.name] = isHomo;
                    const cb = document.getElementById(`filter-${s.name.replace(/\W/g, '_')}`);
                    if(cb) cb.checked = isHomo;
                });
                updateUIForCurrentPeriod();
                updateQuickFilterActiveState('filter-homo');
            });

            if(domElements.climateToggle) { 
                domElements.climateToggle.addEventListener('change', () => {
                    if (timePeriodsData.length > 0 && fetchedIceSheetGeoJson) { 
                         updateUIForCurrentPeriod(); 
                    }
                });
            }
        }
    
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDomElements(); 
            addEventListeners();   
            fetchAllRequiredData();
        });
        </script>
  </body>
</html>